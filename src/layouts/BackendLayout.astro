---
// src/layouts/BackendLayout.astro
const { pageTitle = 'Dashboard', children } = Astro.props;
---

<html lang="en" class="bg-slate-950 text-slate-100">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
  </head>
  <body class="min-h-screen flex flex-col">
    <aside class="w-full bg-slate-900/90 border-b border-slate-800 px-4 py-3 shadow-lg backdrop-blur supports-[backdrop-filter]:bg-slate-900/70">
      <div class="container mx-auto flex items-center justify-between gap-4">
        <nav class="flex items-center gap-2 text-sm">
          <a href="/app" class="rounded-md px-3 py-2 text-slate-200 hover:bg-slate-800 hover:text-white" data-nav="/app">Overview</a>
          <a href="/app/clients" class="rounded-md px-3 py-2 text-slate-200 hover:bg-slate-800 hover:text-white" data-nav="/app/clients">Clients</a>
          <a href="/app/projects" class="rounded-md px-3 py-2 text-slate-200 hover:bg-slate-800 hover:text-white" data-nav="/app/projects">Projects</a>
          <a href="/app/websites" class="rounded-md px-3 py-2 text-slate-200 hover:bg-slate-800 hover:text-white" data-nav="/app/websites">Websites</a>
          <a href="/app/tasks" class="rounded-md px-3 py-2 text-slate-200 hover:bg-slate-800 hover:text-white" data-nav="/app/tasks">Tasks</a>
          <a href="/app/documents" class="rounded-md px-3 py-2 text-slate-200 hover:bg-slate-800 hover:text-white" data-nav="/app/documents">Documents</a>
          <a href="/app/invoices" class="rounded-md px-3 py-2 text-slate-200 hover:bg-slate-800 hover:text-white" data-nav="/app/invoices">Invoices</a>
          <a href="/app/support" class="rounded-md px-3 py-2 text-slate-200 hover:bg-slate-800 hover:text-white" data-nav="/app/support">Support</a>
          <a href="/app/subscriptions" class="rounded-md px-3 py-2 text-slate-200 hover:bg-slate-800 hover:text-white" data-nav="/app/subscriptions">Subscriptions</a>
          <a href="/app/settings" class="rounded-md px-3 py-2 text-slate-200 hover:bg-slate-800 hover:text-white" data-nav="/app/settings">Settings</a>
        </nav>
        <div class="flex items-center gap-3">
          <span id="auth-user" class="text-xs text-slate-400">Checking session…</span>
          <button id="signout" class="rounded-md border border-slate-700 px-3 py-1.5 text-xs text-slate-200 hover:bg-slate-800">Sign out</button>
        </div>
      </div>
    </aside>

    <main class="flex-1 container mx-auto p-6">
      <slot />
    </main>

    <footer class="bg-slate-900 text-center py-4 text-xs text-slate-500">
      © {new Date().getFullYear()} tonsiteweb.ch
    </footer>
    <script type="module">
      import { clearAuthSession } from '~/utils/backend/api';

      const ACCESS_TOKEN_KEY = 'tonsiteweb:accessToken';
      const userLabel = document.getElementById('auth-user');
      const signout = document.getElementById('signout');

      // Highlight active nav
      const currentPath = location.pathname;
      document.querySelectorAll('[data-nav]').forEach((link) => {
        const el = link;
        const href = el.getAttribute('data-nav');
        if (!href) return;
        if (currentPath === href) {
          el.classList.add('bg-slate-800', 'text-white');
        }
      });

      function getToken() {
        try {
          return window.localStorage.getItem(ACCESS_TOKEN_KEY);
        } catch (_) {
          return null;
        }
      }

      async function ensureSession() {
        const token = getToken();
        if (!token) {
          location.href = `/auth/signin?next=${encodeURIComponent(location.pathname)}`;
          return;
        }
        try {
          const res = await fetch('/api/auth/session', { headers: { Authorization: `Bearer ${token}` } });
          if (!res.ok) throw new Error('unauthorized');
          const data = await res.json().catch(() => null);
          if (userLabel) userLabel.textContent = data?.user?.email || 'Signed in';
        } catch (e) {
          clearAuthSession();
          location.href = `/auth/signin?next=${encodeURIComponent(location.pathname)}`;
        }
      }

      signout?.addEventListener('click', () => {
        clearAuthSession();
        location.href = '/auth/signin';
      });

      ensureSession();
    </script>
  </body>
</html>
