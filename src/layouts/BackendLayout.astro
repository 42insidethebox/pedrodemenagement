---
// src/layouts/BackendLayout.astro
import '~/assets/styles/tailwind.css';
import ToggleTheme from '~/components/common/ToggleTheme.astro';
import BasicScripts from '~/components/common/BasicScripts.astro';
import ApplyColorMode from '~/components/common/ApplyColorMode.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import CommonMeta from '~/components/common/CommonMeta.astro';
import Favicons from '~/components/Favicons.astro';
import Metadata from '~/components/common/Metadata.astro';
import SiteVerification from '~/components/common/SiteVerification.astro';
import Analytics from '~/components/common/Analytics.astro';
import { I18N } from 'astrowind:config';

const { pageTitle = 'Dashboard', children } = Astro.props;
const { textDirection } = I18N;
const path = Astro.url?.pathname || '/';
const match = path.match(/^\/(fr|en|de|it)(?=\/|$)/);
const language = (match && match[1]) || 'fr';
const localePrefix = match ? `/${language}` : '';
const authLabels: Record<string, { checking: string; signout: string }> = {
  fr: { checking: 'Vérification de session…', signout: 'Se déconnecter' },
  en: { checking: 'Checking session…', signout: 'Sign out' },
  de: { checking: 'Sitzung wird geprüft…', signout: 'Abmelden' },
  it: { checking: 'Verifica sessione…', signout: 'Disconnetti' },
};
const authText = authLabels[language] || authLabels.fr;
const search = Astro.url?.search || '';
const rawPath = path.replace(/^\/(fr|en|de|it)(?=\/|$)/, '') || '/';
const baseSuffix = rawPath.startsWith('/') ? rawPath : `/${rawPath}`;
const buildLangHref = (lang: 'fr' | 'en' | 'de' | 'it') => `/${lang}${baseSuffix}${search}`;
const navHref = (href: string) => `${localePrefix}${href}`;
---

<html lang={language} dir={textDirection} class="2xl:text-[20px]">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <CommonMeta />
    <Favicons />
    <CustomStyles />
    <ApplyColorMode />
    <Metadata />
    <SiteVerification />
    <Analytics />
  </head>
  <body class="min-h-screen flex flex-col antialiased text-default bg-page tracking-tight">
    <aside class="w-full border-b border-slate-200 bg-white/90 px-4 py-3 shadow-sm backdrop-blur supports-[backdrop-filter]:bg-white/70 dark:border-slate-800 dark:bg-slate-900/90 dark:shadow-lg">
      <div class="container mx-auto flex items-center justify-between gap-4">
        
        <nav class="flex items-center gap-2 text-sm">
          <a href={navHref('/app')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app')} data-i18n="nav.overview">Overview</a>
          <a href={navHref('/app/leads')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/leads')} data-i18n="nav.leads">Leads</a>
          <a href={navHref('/app/clients')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/clients')} data-i18n="nav.clients">Clients</a>
          <a href={navHref('/app/projects')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/projects')} data-i18n="nav.projects">Projects</a>
          <a href={navHref('/app/websites')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/websites')} data-i18n="nav.websites">Websites</a>
          <a href={navHref('/app/tasks')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/tasks')} data-i18n="nav.tasks">Tasks</a>
          <a href={navHref('/app/documents')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/documents')} data-i18n="nav.documents">Documents</a>
          <a href={navHref('/app/invoices')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/invoices')} data-i18n="nav.invoices">Invoices</a>
          <a href={navHref('/app/orders')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/orders')} data-i18n="nav.orders">Orders</a>
          <a href={navHref('/app/support')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/support')} data-i18n="nav.support">Support</a>
          <a href={navHref('/app/subscriptions')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/subscriptions')} data-i18n="nav.subscriptions">Subscriptions</a>
          <a href={navHref('/app/settings')} class="rounded-md px-3 py-2 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" data-nav={navHref('/app/settings')} data-i18n="nav.settings">Settings</a>
        </nav>
        <div class="flex items-center gap-3">
          <div class="hidden md:block">
            <ToggleTheme iconClass="w-5 h-5" />
          </div>
          <div class="relative dropdown hidden md:block">
            <button type="button" class="flex items-center whitespace-nowrap rounded-md px-3 py-2.5 text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:text-white" aria-label="Language">
              <span data-i18n="nav.languageLabel">Langue</span>
              <svg width="1em" height="1em" viewBox="0 0 24 24" class="w-3.5 h-3.5 ml-0.5 rtl:ml-0 rtl:mr-0.5 hidden md:inline" data-icon="tabler:chevron-down">
                <path fill="currentColor" d="M7 10l5 5l5-5" />
              </svg>
            </button>
            <ul class="dropdown-menu md:backdrop-blur-md dark:md:bg-dark rounded md:absolute pl-4 md:pl-0 md:hidden font-medium md:bg-white/90 md:min-w-[200px] drop-shadow-xl">
              <li><a class="first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block whitespace-no-wrap" href={buildLangHref('fr')} data-lang="fr"> Français </a></li>
              <li><a class="first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block whitespace-no-wrap" href={buildLangHref('en')} data-lang="en"> English </a></li>
              <li><a class="first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block whitespace-no-wrap" href={buildLangHref('de')} data-lang="de"> Deutsch </a></li>
              <li><a class="first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block whitespace-no-wrap" href={buildLangHref('it')} data-lang="it"> Italiano </a></li>
            </ul>
          </div>
          <span id="auth-user" class="text-xs text-slate-500 dark:text-slate-400" data-i18n="auth.checking">{authText.checking}</span>
          <button id="signout" class="rounded-md border border-slate-300 px-3 py-1.5 text-xs text-slate-600 transition hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" data-i18n="auth.signout">{authText.signout}</button>
        </div>
      </div>
    </aside>

    <main class="flex-1 container mx-auto p-6">
      <slot />
    </main>

    <footer class="bg-slate-100 text-center py-4 text-xs text-slate-500 dark:bg-slate-900">
      © {new Date().getFullYear()} pedrodemenagement.ch
    </footer>
    <BasicScripts />
    <script type="module">
      import { clearAuthSession } from '~/utils/backend/api';
      import { applyTranslations, getLanguageLabel, getPreferredLocale, setPreferredLocale } from '~/utils/i18n';

      const ACCESS_TOKEN_KEY = 'pedrodemenagement:accessToken';
      const userLabel = document.getElementById('auth-user');
      const signout = document.getElementById('signout');
      const langLabel = document.querySelector('[data-i18n="nav.languageLabel"]');
      const langLinks = document.querySelectorAll('a[data-lang]');
      const langPrefix = (location.pathname.match(/^\/(fr|en|de|it)(?=\/|$)/)?.[0]) || '';
      const signInBase = `${langPrefix || ''}/auth/signin`;

      const locale = getPreferredLocale();
      applyTranslations(locale);
      if (langLabel) langLabel.textContent = getLanguageLabel(locale);

      // Highlight active nav
      const currentPath = location.pathname;
      document.querySelectorAll('[data-nav]').forEach((link) => {
        const el = link;
        const href = el.getAttribute('data-nav');
        if (!href) return;
        if (currentPath === href) {
          el.classList.add('bg-slate-100', 'text-slate-900', 'dark:bg-slate-800', 'dark:text-white');
        }
      });

      function getToken() {
        try {
          return window.localStorage.getItem(ACCESS_TOKEN_KEY);
        } catch (_) {
          return null;
        }
      }

      async function ensureSession() {
        const token = getToken();
        if (!token) {
          location.href = `${signInBase}?next=${encodeURIComponent(location.pathname)}`;
          return;
        }
        try {
          const res = await fetch('/api/auth/session', { headers: { Authorization: `Bearer ${token}` } });
          if (!res.ok) throw new Error('unauthorized');
          const data = await res.json().catch(() => null);
          if (userLabel) userLabel.textContent = data?.user?.email || 'Signed in';
        } catch (e) {
          clearAuthSession();
          location.href = `${signInBase}?next=${encodeURIComponent(location.pathname)}`;
        }
      }

      signout?.addEventListener('click', async () => {
        const token = getToken();
        clearAuthSession();
        try {
          await fetch('/api/auth/session', {
            method: 'DELETE',
            headers: token ? { Authorization: `Bearer ${token}` } : undefined,
          });
        } catch (_) {
          // ignore network issues on logout
        }
        try {
          window.location.replace(signInBase);
        } catch (_) {
          location.href = signInBase;
        }
      });

      langLinks.forEach((a) => {
        a.addEventListener('click', (event) => {
          const code = a.getAttribute('data-lang');
          if (!code) return;
          event.preventDefault();
          setPreferredLocale(code);
          applyTranslations(getPreferredLocale());
          if (langLabel) langLabel.textContent = getLanguageLabel(getPreferredLocale());
          const href = computeLangHref(code);
          if (href) {
            try {
              window.location.assign(href);
            } catch (_) {
              // ignore navigation issues
            }
          }
        });
      });

      ensureSession();
      // Language switch: always use localized URLs similar to marketing pages
      function computeLangHref(lang) {
        const path = location.pathname || '/';
        const search = location.search || '';
        const hash = location.hash || '';
        const rawPath = path.replace(/^\/(fr|en|de|it)(?=\/|$)/, '') || '/';
        const base = rawPath.startsWith('/') ? rawPath : `/${rawPath}`;
        return `/${lang}${base}${search}${hash}`;
      }

      document.querySelectorAll('[data-lang]').forEach((a) => {
        const lang = a.getAttribute('data-lang');
        if (!lang) return;
        a.setAttribute('href', computeLangHref(lang));
      });
    </script>
  </body>
</html>
