---
import { Icon } from 'astro-icon/components';
import Logo from '~/components/Logo.astro';
import ToggleMenu from '~/components/common/ToggleMenu.astro';
import Button from '~/components/ui/Button.astro';
import { twMerge } from 'tailwind-merge';

import { getHomePermalink } from '~/utils/permalinks';
import { trimSlash, getAsset } from '~/utils/permalinks';
import { resolveLocaleFromRequest } from '~/lib/locale';
import type { CallToAction } from '~/types';

interface Link {
  text?: string;
  href?: string;
  ariaLabel?: string;
  icon?: string;
}

interface MenuLink extends Link {
  links?: Array<MenuLink>;
}

export interface Props {
  id?: string;
  links?: Array<MenuLink>;
  actions?: Array<CallToAction>;
  brandName?: string;
  brandKey?: string;
  isSticky?: boolean;
  isDark?: boolean;
  isFullWidth?: boolean;
  showRssFeed?: boolean;
  position?: string;
}

const {
  id = 'header',
  links = [],
  actions = [],
  brandName = undefined,
  brandKey = 'pedro',
  isSticky = false,
  isDark = false,
  isFullWidth = false,
  showRssFeed = false,
  position = 'center',
} = Astro.props;

const urlObj = new URL(Astro.url);
const currentPath = `/${trimSlash(urlObj.pathname)}` || '/';
const filteredLinks = links ?? [];
const isUrgent = brandKey === 'urgent';
const toneClass =
  brandKey === 'videsuccession' || brandKey === 'pedro' || brandKey === 'lausanne'
    ? 'header-tone-light'
    : brandKey === 'lausannenettoyage'
      ? 'header-tone-light'
      : 'header-tone-white';
const brandLangs: Record<string, string[]> = {
  laclemanexperience: ['fr', 'en', 'de', 'it', 'ar', 'zh'],
  lausanne: ['fr', 'en', 'de', 'it'],
};
const supportedLangs = brandLangs[brandKey] ?? ['fr'];
const brandDefaultLocale = brandKey === 'laclemanexperience' ? 'en' : 'fr';
const initialResolved = resolveLocaleFromRequest(Astro.request, brandDefaultLocale);
const initialLang = supportedLangs.includes(initialResolved) ? initialResolved : supportedLangs[0] || 'fr';
const flagClasses: Record<string, string> = {
  fr: 'aw-flag-fr',
  en: 'aw-flag-en',
  de: 'aw-flag-de',
  it: 'aw-flag-it',
  ar: 'aw-flag-ar',
  zh: 'aw-flag-zh',
};
---

<header
  class:list={[
    { sticky: isSticky, relative: !isSticky, dark: isDark },
    'top-0 z-40 flex-none mx-auto w-full border-b border-gray-50/0 transition-[opacity] ease-in-out aw-header',
    toneClass,
    isUrgent ? 'bg-gradient-to-r from-red-900 via-red-700 to-orange-500 text-white shadow-lg' : '',
  ]}
  {...isSticky ? { 'data-aw-sticky-header': true } : {}}
  {...id ? { id } : {}}
>
  <div class="absolute inset-0"></div>
  <div
    class:list={[
      'relative text-default py-3 px-3 md:px-6 mx-auto w-full',
      {
        'md:flex md:justify-between': position !== 'center',
      },
      {
  'md:flex md:items-center md:justify-between': position === 'center',
},
,
      {
        'max-w-7xl': !isFullWidth,
      },
    ]}
  >
    <div class:list={[{ 'mr-auto rtl:mr-0 rtl:ml-auto': position === 'right' }, 'flex justify-between md:flex-shrink-0']}>
      <a class="flex items-center" href={getHomePermalink()}>
        <Logo name={brandName} />
      </a>
      <div class="flex items-center gap-2 md:hidden">
        <ToggleMenu />
      </div>
    </div>
    <nav
      class="items-center w-full md:flex-1 md:min-w-0 hidden md:flex md:mx-4 text-default overflow-y-auto overflow-x-hidden md:overflow-y-visible md:overflow-x-auto md:justify-self-center"
      aria-label="Main navigation"
    >
      <ul
        class="flex flex-col md:flex-row md:flex-wrap xl:flex-nowrap md:self-center w-full md:w-auto text-xl md:text-[0.9375rem] tracking-[0.01rem] font-medium md:justify-center md:gap-1 md:min-w-0"
      >
        {supportedLangs.length > 1 && (
          <li class="md:hidden px-3 py-3">
            <div class="lang-select-wrap">
              <span class={`aw-flag ${flagClasses[initialLang] || ''}`} data-aw-lang-flag></span>
              <select
                id="lang-select-mobile"
                data-initial={initialLang}
                data-aw-lang-select
                onchange="window.__awSetLang && window.__awSetLang(this.value)"
                class="appearance-none rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-900 shadow-sm"
              >
                {supportedLangs.map((code) => (
                  <option value={code} selected={initialLang === code}>{code.toUpperCase()}</option>
                ))}
              </select>
            </div>
          </li>
        )}
        {
          filteredLinks.map(({ text, href, links }) => (
          <li class={links?.length ? 'dropdown' : ''}>
            {links?.length ? (
              <>
                <button
                  type="button"
                  class:list={[
                    'hover:text-link dark:hover:text-white px-3 min-[1100px]:px-4 py-3 flex items-center whitespace-nowrap',
                    isUrgent ? 'text-white hover:text-orange-100' : '',
                  ]}
                >
                  {text}{' '}
                  <Icon name="tabler:chevron-down" class="w-3.5 h-3.5 ml-0.5 rtl:ml-0 rtl:mr-0.5 hidden md:inline" />
                </button>
                <ul class="dropdown-menu md:backdrop-blur-md dark:md:bg-dark rounded md:absolute pl-4 md:pl-0 md:hidden font-medium md:bg-white/90 md:min-w-[200px] drop-shadow-xl">
                  {(links || []).map(({ text: text2, href: href2 }) => (
                    <li>
                      <a
                        class:list={[
                          'first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block whitespace-no-wrap',
                          isUrgent ? 'md:text-slate-900' : '',
                          { 'aw-link-active': href2 === currentPath },
                        ]}
                        href={href2}
                      >
                        {text2}
                      </a>
                    </li>
                  ))}
                </ul>
              </>
            ) : (
              <a
                class:list={[
                  'hover:text-link dark:hover:text-white px-3 min-[1100px]:px-4 py-3 flex items-center whitespace-nowrap',
                  isUrgent ? 'text-white hover:text-orange-100' : '',
                  toneClass === 'header-tone-light' ? 'text-slate-900 hover:text-slate-700' : 'text-white hover:text-slate-100',
                  { 'aw-link-active': href === currentPath },
                ]}
                href={href}
              >
                {text}
              </a>
              )}
            </li>
          ))
        }
      </ul>
    </nav>
    <div
      class:list={[
        { 'ml-auto rtl:ml-0 rtl:mr-auto': position === 'left' },
        'hidden md:self-center md:flex items-center md:mb-0 fixed w-full md:w-auto md:static justify-end left-0 rtl:left-auto rtl:right-0 bottom-0 p-3 md:p-0 md:justify-self-end md:flex-shrink-0',
      ]}
    >
      <div class="items-center flex justify-between w-full md:w-auto">
        <div class="flex items-center gap-2">
          <div class="relative">
            <label for="lang-select" class="sr-only">Langue</label>
            <div class="lang-select-wrap">
              <span class={`aw-flag ${flagClasses[initialLang] || ''}`} data-aw-lang-flag></span>
              <select
                id="lang-select"
                data-initial={initialLang}
                data-aw-lang-select
                onchange="window.__awSetLang && window.__awSetLang(this.value)"
                class="appearance-none rounded-full border border-white/50 bg-white/90 px-3 py-1.5 text-sm font-semibold text-slate-900 shadow-sm backdrop-blur md:px-3.5 md:py-2 dark:border-slate-600 dark:bg-slate-800 dark:text-white"
              >
                {supportedLangs.map((code) => (
                  <option value={code} selected={initialLang === code}>{code.toUpperCase()}</option>
                ))}
              </select>
            </div>
          </div>
          {
            showRssFeed && (
              <a
                class="text-muted dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center"
                aria-label="RSS Feed"
                href={getAsset('/rss.xml')}
              >
                <Icon name="tabler:rss" class="w-5 h-5" />
              </a>
            )
          }
        </div>
        {actions?.length ? (
          <span class="ml-4 rtl:ml-0 rtl:mr-4">
            {actions.map((btnProps) => (
              <Button
                {...btnProps}
                variant={isUrgent ? 'primary' : btnProps.variant}
                class={twMerge(
                  'ml-2 py-2.5 px-5.5 md:px-6 font-semibold text-sm w-auto',
                  isUrgent
                    ? 'bg-red-600 hover:bg-orange-500 text-white shadow-red-500/30 border-transparent'
                    : toneClass === 'header-tone-light'
                      ? 'bg-white text-slate-900 hover:bg-slate-100 border border-slate-200 shadow-sm'
                      : 'bg-white text-slate-900 hover:bg-slate-100 border-transparent shadow-sm'
                )}
              />
            ))}
          </span>
        ) : (
          ''
        )}
      </div>
    </div>
  </div>
</header>

<script>
  (() => {
    const getSupported = () => {
      const selects = Array.from(document.querySelectorAll('[data-aw-lang-select]'));
      const opts = new Set();
      selects.forEach((sel) => {
        sel.querySelectorAll('option').forEach((opt) => opts.add(opt.value));
      });
      return opts.size ? Array.from(opts) : ['fr'];
    };
    const flagMap = {
      fr: 'aw-flag-fr',
      en: 'aw-flag-en',
      de: 'aw-flag-de',
      it: 'aw-flag-it',
      ar: 'aw-flag-ar',
      zh: 'aw-flag-zh',
    };
    const updateFlags = (lang) => {
      document.querySelectorAll('[data-aw-lang-flag]').forEach((el) => {
        const base = Array.from(el.classList).filter((c) => !c.startsWith('aw-flag-'));
        const cls = flagMap[lang];
        el.className = [...base, 'aw-flag', cls || ''].join(' ').trim();
      });
    };

    const detectLang = (selects) => {
      const supported = getSupported();
      const stored = localStorage.getItem('aw-lang');
      if (stored && supported.includes(stored)) return stored;
      const cookie = document.cookie.split('; ').find((c) => c.startsWith('aw_lang='));
      if (cookie) {
        const val = cookie.split('=')[1];
        if (supported.includes(val)) return val;
      }
      const initial = selects[0]?.dataset.initial;
      if (initial && supported.includes(initial)) return initial;
      const htmlLang = (document.documentElement.lang || '').slice(0, 2).toLowerCase();
      if (supported.includes(htmlLang)) return htmlLang;
      const nav = (navigator.language || 'fr').slice(0, 2).toLowerCase();
      return supported.includes(nav) ? nav : 'fr';
    };

    const applyLang = (lang, selects) => {
      const supported = getSupported();
      document.documentElement.lang = lang;
      localStorage.setItem('aw-lang', lang);
      document.cookie = `aw_lang=${lang}; path=/; max-age=${60 * 60 * 24 * 365}; SameSite=Lax`;
      selects.forEach((sel) => (sel.value = lang));
      window.dispatchEvent(new CustomEvent('aw:lang-change', { detail: { lang } }));
      updateFlags(lang);
    };

    if (!window.__awSetLang) {
      window.__awSetLang = (lang) => {
        const supported = getSupported();
        if (!supported.includes(lang)) return;
        const selects = Array.from(document.querySelectorAll('[data-aw-lang-select]'));
        applyLang(lang, selects);
        window.location.reload();
      };
    }

    const bind = () => {
      const selects = Array.from(document.querySelectorAll('[data-aw-lang-select]'));
      if (!selects.length) return;
      const lang = detectLang(selects);
      applyLang(lang, selects);
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bind, { once: true });
    } else {
      bind();
    }
    window.addEventListener('pageshow', bind);
  })();
</script>

<style>
  .lang-select-wrap {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }
  .aw-flag {
    width: 18px;
    height: 12px;
    border-radius: 3px;
    border: 1px solid rgba(15, 23, 42, 0.15);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    flex-shrink: 0;
  }
  .aw-flag-fr { background: linear-gradient(90deg, #0055a4 0 33%, #fff 33% 66%, #ef4135 66% 100%); }
  .aw-flag-en {
    background: #012169;
    background-image: url("data:image/svg+xml,%3Csvg width='18' height='12' viewBox='0 0 18 12' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='18' height='12' fill='%23012169'/%3E%3Cpath d='M0 0l7 4.5V0h4v4.5L18 0v2l-6.5 4.5H18v2h-6.5L18 13v-1.5L11 7.5V12H7V7.5L0 11.5V9l6.5-4.5H0v-2h6.5L0 2V0z' fill='%23fff'/%3E%3Cpath d='M0 0l6 4h-2L0 .7V0zm18 0v.7L14 4h-2l6-4zM14 8l4 3.3V12l-6-4h2zm-8 0L0 12v-1l4-3h2z' fill='%23C8102E'/%3E%3Cpath d='M7 0h4v12H7zM0 4h18v4H0z' fill='%23C8102E'/%3E%3C/svg%3E");
    background-size: cover;
  }
  .aw-flag-de { background: linear-gradient(180deg, #000 0 33%, #dd0000 33% 66%, #ffce00 66% 100%); }
  .aw-flag-it { background: linear-gradient(90deg, #009246 0 33%, #fff 33% 66%, #ce2b37 66% 100%); }
  .aw-flag-ar { background: linear-gradient(180deg, #007a3d 0 33%, #fff 33% 66%, #000 66% 100%); }
  .aw-flag-zh {
    background: #de2910;
    background-image: url("data:image/svg+xml,%3Csvg width='18' height='12' viewBox='0 0 18 12' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='18' height='12' fill='%23de2910'/%3E%3Cpolygon fill='%23ffde00' points='3,5 3.9,7.8 1.4,6 4.6,6 2.1,7.8'/%3E%3Cpolygon fill='%23ffde00' points='6.3,2.3 6.9,3.5 5.7,2.9 6.9,2.3 6.3,3.5' transform='rotate(-20 6.3 2.9)'/%3E%3Cpolygon fill='%23ffde00' points='7.5,3.9 8.3,5 7,4.6 8.2,4.2 7.4,5.2' transform='rotate(10 7.7 4.7)'/%3E%3Cpolygon fill='%23ffde00' points='7.6,6.3 8.5,7.4 7.1,7 8.3,6.6 7.5,7.6' transform='rotate(25 7.8 7)'/%3E%3Cpolygon fill='%23ffde00' points='6.2,7.9 7,9 5.7,8.6 6.9,8.2 6.1,9.2' transform='rotate(5 6.3 8.8)'/%3E%3C/svg%3E");
    background-size: cover;
  }
  :global(.aw-header.header-tone-light) {
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.92), rgba(255, 255, 255, 0.88));
    color: #0f172a;
    border-bottom: 1px solid rgba(15, 23, 42, 0.06);
    backdrop-filter: blur(12px);
  }
  :global(.aw-header.header-tone-light a) {
    color: #0f172a;
  }
  :global(.aw-header.header-tone-white) {
    color: #f8fafc;
    backdrop-filter: blur(10px);
  }
  :global(.aw-header.header-tone-white a) {
    color: #f8fafc;
  }
  :global(.brand-lausanne .aw-header.header-tone-light) {
    background: #fff;
    background-image: none;
    color: #0f172a;
  }
  :global(.brand-lausanne .aw-header.header-tone-light a) {
    color: #0f172a;
  }
</style>
