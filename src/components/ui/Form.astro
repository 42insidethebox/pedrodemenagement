---
import type { Form as Props } from '~/types';
import Button from '~/components/ui/Button.astro';

const {
  inputs,
  textarea,
  disclaimer,
  button = 'Envoyer',
  description = '',
  action = 'mailto:contact@lausannedemenagement.ch?subject=Demande%20de%20devis',
  method = 'post',
  encType = 'text/plain',
} = Astro.props as Props & { action?: string; method?: string; encType?: string };

const sections: string[] = [];
let currentStep = -1;
const fieldsWithStep =
  (inputs || [])
    .map((field) => {
      if (!field) return null;
      if ((field as any).type === 'section') {
        currentStep += 1;
        sections.push((field as any).label || `Étape ${currentStep + 1}`);
        return { field, step: currentStep, isSection: true };
      }
      return { field, step: Math.max(currentStep, 0), isSection: false };
    })
    .filter(Boolean) || [];

if (!sections.length) {
  sections.push('Étape 1');
  fieldsWithStep.forEach((item: any) => (item.step = 0));
}
---

<form
  method={method}
  action={action}
  {...(encType ? { enctype: encType } : {})}
  data-enhanced="true"
  data-stepper-mobile
  class="space-y-6"
>
  {sections.length > 1 && (
    <div class="flex flex-wrap items-center justify-center gap-2 sm:gap-3 text-center" data-step-progress>
      {sections.map((label, idx) => (
        <div class="flex items-center justify-center gap-2 sm:gap-3">
          <div
            class="h-9 w-9 rounded-full border border-primary/30 text-sm flex items-center justify-center font-semibold text-primary/80 bg-primary/5"
            data-step-dot
            data-step={idx + ''}
          >
            {idx + 1}
          </div>
          <span
            class="text-xs sm:text-sm text-slate-500 dark:text-slate-300 hidden sm:inline transition-colors"
            data-step-label={idx + ''}
          >
            {label}
          </span>
          {idx < sections.length - 1 ? <div class="w-8 h-px bg-slate-300/70 dark:bg-slate-700/70"></div> : null}
        </div>
      ))}
    </div>
  )}
  {sections.length > 1 && (
    <div class="sm:hidden">
      <div class="relative h-2 rounded-full bg-slate-200/80 dark:bg-slate-800/80 overflow-hidden" data-step-progress-bar>
        <span class="absolute inset-y-0 left-0 bg-primary/80 transition-[width] duration-300 ease-out" style={`width:${(1 / sections.length) * 100}%`}></span>
      </div>
      <div class="mt-2 text-[11px] uppercase tracking-[0.2em] text-slate-500 dark:text-slate-400 font-semibold" data-step-mobile-label>
        {sections[0]}
      </div>
    </div>
  )}

  <div class="grid grid-cols-1 md:grid-cols-2 gap-5 md:gap-8" data-stepper-fields>
    {
      fieldsWithStep.map(({ field, step, isSection }: any) => {
        if (!(field as any).name && !isSection) return null;
        const {
          type = 'text',
          name,
          label = '',
          autocomplete = 'on',
          placeholder = '',
          options = [],
          multiple = false,
          required = false,
          helper = '',
          requiredMessage = '',
          conditional,
          colSpan = 1,
          className = '',
        } = field as any;

        if (isSection) {
          return (
            <div
              class="col-span-1 md:col-span-2 pt-10 pb-4 border-t border-gray-200 dark:border-gray-700 mt-6 bg-gray-50/70 dark:bg-slate-800/70 rounded-xl px-5 shadow-sm"
              data-step={step}
              data-step-section
            >
              {label && <h3 class="text-lg md:text-xl font-semibold tracking-tight text-slate-900 dark:text-white">{label}</h3>}
            </div>
          );
        }

        return (
          <div
            class={`space-y-2 ${colSpan === 2 ? 'md:col-span-2' : ''} ${className}`}
            data-field-wrapper
            data-step={step}
            data-conditional-source={conditional?.source}
            data-conditional-show={conditional?.showOn?.join(',')}
            data-conditional-hide={conditional?.hideOn?.join(',')}
            data-conditional-anynot={conditional?.showIfAnyNot?.join(',')}
          >
            {label && (
              <label for={name} class="flex items-center gap-2 text-sm font-semibold text-slate-800 dark:text-slate-100">
                <span>{label}</span>
                {required ? <span class="text-red-500" aria-hidden="true">*</span> : null}
                {(type === 'checkbox' || multiple) && (
                  <span class="inline-flex items-center rounded-full bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-200 px-2 py-0.5 text-[11px] font-medium">
                    Plusieurs choix
                  </span>
                )}
              </label>
            )}
            {helper && <p class="text-xs text-gray-500 helper-text">{helper}</p>}
            {required && requiredMessage && <p class="text-xs text-red-500 required-msg hidden">{requiredMessage}</p>}

            {type === 'select' ? (
              <select
                name={name}
                id={name}
                multiple={multiple}
                required={required}
                title={required && requiredMessage ? requiredMessage : undefined}
                class="py-3 px-4 pr-12 block w-full text-md rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm hover:border-primary/50 focus:border-primary/70 focus:ring-2 focus:ring-primary/30 transition-all appearance-none"
                style="background-image: url('data:image/svg+xml;utf8,<svg fill=\"none\" stroke=\"%23718096\" stroke-width=\"1.6\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M6 9l6 6 6-6\"/></svg>'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 14px;"
              >
                {(options.length ? options : [{ value: '', label: 'Select an option' }]).map((option: any) => (
                  <option value={option.value}>{option.label ?? option.value}</option>
                ))}
              </select>
            ) : type === 'checkbox' ? (
              <div class="space-y-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm px-4 py-3">
                {(options.length ? options : [{ value: 'yes', label: 'Oui' }]).map((option: any, index: number) => (
                  <label class="flex items-center gap-3 text-sm text-slate-800 dark:text-slate-100">
                    <input
                      type="checkbox"
                      name={`${name}[]`}
                      value={option.value}
                      required={required && index === 0}
                      title={required && requiredMessage ? requiredMessage : undefined}
                      class="h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary focus:ring-2 focus:ring-offset-1 focus:ring-offset-white dark:focus:ring-offset-slate-900"
                    />
                    <span>{option.label ?? option.value}</span>
                  </label>
                ))}
              </div>
            ) : type === 'radio' ? (
              <div class="space-y-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm px-4 py-3">
                {(options.length ? options : [{ value: 'oui', label: 'Oui' }]).map((option: any, index: number) => (
                  <label class="flex items-center gap-3 text-sm text-slate-800 dark:text-slate-100">
                    <input
                      type="radio"
                      name={name}
                      value={option.value}
                      required={required && index === 0}
                      title={required && requiredMessage ? requiredMessage : undefined}
                      class="h-4 w-4 rounded-full border-slate-300 text-primary focus:ring-primary focus:ring-2 focus:ring-offset-1 focus:ring-offset-white dark:focus:ring-offset-slate-900"
                    />
                    <span>{option.label ?? option.value}</span>
                  </label>
                ))}
              </div>
            ) : (
              <input
                type={type}
                name={name}
                id={name}
                autocomplete={autocomplete}
                placeholder={placeholder}
                required={required}
                title={
                  type === 'tel'
                    ? 'Merci d’entrer un numéro suisse (+41 XX XXX XX XX ou 0XX XXX XX XX).'
                    : required && requiredMessage
                      ? requiredMessage
                      : undefined
                }
                pattern={
                  type === 'tel'
                    ? '(\\+41|0)[\\s.-]?\\d{2}[\\s.-]?\\d{3}[\\s.-]?\\d{2}[\\s.-]?\\d{2}'
                    : undefined
                }
                inputMode={type === 'tel' ? 'tel' : undefined}
                data-validate={type === 'tel' ? 'ch-phone' : undefined}
                class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors"
              />
            )}
          </div>
        );
      })
    }

    {
      textarea && (
        <div class="col-span-1 md:col-span-2 space-y-2" data-field-wrapper data-step={(sections.length ? sections.length - 1 : 0)}>
          <label for="textarea" class="block text-sm font-medium text-slate-800 dark:text-slate-100">
            {textarea.label} {textarea.required ? <span class="text-red-500" aria-hidden="true">*</span> : null}
          </label>
          <textarea
            id="textarea"
            name={textarea.name ? textarea.name : 'message'}
            rows={textarea.rows ? textarea.rows : 4}
            placeholder={textarea.placeholder}
            {...(textarea as any)?.required ? { required: true } : {}}
            class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors"
          />
        </div>
      )
    }

    {
      disclaimer && (
        <div class="col-span-1 md:col-span-2 mt-3 flex items-start space-x-3" data-step={(sections.length ? sections.length - 1 : 0)}>
          <div class="flex mt-0.5">
            <input
              id="disclaimer"
              name="disclaimer"
              type="checkbox"
              class="cursor-pointer h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
            />
          </div>
          <div class="ml-3">
            <label for="disclaimer" class="cursor-pointer select-none text-sm text-gray-600 dark:text-gray-400">
              {disclaimer.label}
            </label>
          </div>
        </div>
      )
    }

    {
      button && (
        <div class="col-span-1 md:col-span-2 mt-10 grid">
          <div class="flex items-center justify-between gap-4 stepper-actions">
            <div class="flex-none w-[132px]">
              <Button
                variant="secondary"
                type="button"
                class="invisible opacity-0 pointer-events-none w-full justify-center"
                data-step-prev
              >
                Précédent
              </Button>
            </div>
            <div class="flex flex-none gap-3 items-center">
              <Button
                variant="secondary"
                type="button"
                class={`flex-none w-[132px] justify-center ${sections.length > 1 ? '' : 'hidden'}`}
                data-step-next
              >
                Suivant
              </Button>
              <Button variant="primary" type="submit" class="flex-none w-[140px] justify-center" data-step-submit>
                {button}
              </Button>
            </div>
          </div>
        </div>
      )
    }

    {
      description && (
        <div class="col-span-1 md:col-span-2 mt-3 text-center">
          <p class="text-sm text-gray-600 dark:text-gray-400">{description}</p>
        </div>
      )
    }
  </div>
</form>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('form[data-enhanced="true"]') as HTMLFormElement | null;

    form
      ?.querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('input, select, textarea')
      .forEach((el) => {
        if (el.required) el.dataset.requiredOriginal = 'true';
      });

    const clearFieldError = (field: HTMLElement | null | undefined) => {
      if (!field) return;
      const wrapper = field.closest('[data-field-wrapper]');
      if (!wrapper) return;
      wrapper.classList.remove('has-error');
      wrapper.querySelectorAll('.required-msg').forEach((msg) => msg.classList.add('hidden'));
      const inputs = wrapper.querySelectorAll('input, select, textarea');
      inputs.forEach((el: any) => el.classList.remove('input-error'));
    };

    const markFieldError = (field: HTMLElement | null | undefined) => {
      if (!field) return;
      const wrapper = field.closest('[data-field-wrapper]');
      if (!wrapper) return;
      wrapper.classList.add('has-error');
      wrapper.querySelectorAll('.required-msg').forEach((msg) => msg.classList.remove('hidden'));
      const inputs = wrapper.querySelectorAll('input, select, textarea');
      inputs.forEach((el: any) => el.classList.add('input-error'));
    };

    const applyConditional = () => {
      document.querySelectorAll('[data-conditional-source]').forEach((el) => {
        const sourceName = el.dataset.conditionalSource;
        if (!sourceName) return;
        const showValues = (el.dataset.conditionalShow || '').split(',').filter(Boolean);
        const hideValues = (el.dataset.conditionalHide || '').split(',').filter(Boolean);
        const anyNot = (el.dataset.conditionalAnynot || '').split(',').filter(Boolean);
        const sourceInputs = document.querySelectorAll(`[name="${sourceName}"], [name="${sourceName}[]"]`);
        if (!sourceInputs.length) return;

        const values: string[] = [];
        sourceInputs.forEach((input: any) => {
          if (input.type === 'checkbox') {
            if (input.checked) values.push(input.value);
          } else if (input.type === 'radio') {
            if (input.checked) values.push(input.value);
          } else if (input.tagName === 'SELECT') {
            values.push(input.value);
          } else if (input.value) {
            values.push(input.value);
          }
        });

        let shouldShow = true;
        if (showValues.length) {
          shouldShow = values.some((v) => showValues.includes(v));
        }
        if (hideValues.length && values.some((v) => hideValues.includes(v))) {
          shouldShow = false;
        }
        if (anyNot.length) {
          const hasNon = values.some((v) => !anyNot.includes(v));
          shouldShow = hasNon;
        }

        const requiredEls = el.querySelectorAll('[required], [data-required-original="true"]');
        if (shouldShow) {
          (el as HTMLElement).style.display = '';
          el.classList.remove('conditional-reveal');
          requiredEls.forEach((r: any) => {
            r.required = r.dataset.requiredOriginal === 'true';
          });
        } else {
          (el as HTMLElement).style.display = 'none';
          el.classList.remove('conditional-reveal');
          requiredEls.forEach((r: any) => {
            r.dataset.requiredOriginal = r.dataset.requiredOriginal === 'true' || r.required ? 'true' : 'false';
            r.required = false;
          });
        }
      });
    };

    const getFieldValue = (name: string) => {
      const el = form?.querySelector<HTMLInputElement | HTMLSelectElement>(`[name="${name}"]`);
      return el?.value || '';
    };

    const getRadioValue = (name: string) => {
      const selected = form?.querySelector<HTMLInputElement>(`input[name="${name}"]:checked`);
      return selected?.value || '';
    };

    const getCheckboxValues = (name: string) =>
      Array.from(form?.querySelectorAll<HTMLInputElement>(`input[name="${name}[]"]`) || [])
        .filter((el) => el.checked)
        .map((el) => el.value);

    const parseFloorValue = (value: string) => (value === '4+' ? 4 : Number(value) || 0);
    const parseApartmentSize = (value: string) => {
      const parsed = parseFloat(value);
      return Number.isNaN(parsed) ? 0 : parsed;
    };

    const computeRiskScore = () => {
      const apartmentSize = parseApartmentSize(getRadioValue('apartment_size'));
      const originFloor = parseFloorValue(getRadioValue('origin_floor'));
      const destFloor = parseFloorValue(getRadioValue('dest_floor'));
      const originElevator = getRadioValue('origin_elevator');
      const destElevator = getRadioValue('dest_elevator');
      const packedReady = getRadioValue('packed_ready');
      const extraSpaces = getCheckboxValues('extra_spaces');
      const bulkyItems = getCheckboxValues('bulky_items');
      const fragileItems = getRadioValue('fragile_items');
      const dismantling = getRadioValue('dismantling');
      const parkingAuthorization = getRadioValue('parking_authorization');
      const stairsType = getRadioValue('stairs_type');
      const confidenceLevel = getRadioValue('confidence_level');
      const clientHelping = getRadioValue('client_helping');

      let score = 0;
      const drivers: string[] = [];

      if (confidenceLevel === 'unsure') {
        score += 2;
        drivers.push('confidence_unsure');
      }

      if (originFloor >= 3 && originElevator === 'no') {
        score += 2;
        drivers.push('origin_floor_no_elevator');
      }
      if (destFloor >= 3 && destElevator === 'no') {
        score += 2;
        drivers.push('dest_floor_no_elevator');
      }

      if (bulkyItems.includes('bulky')) {
        score += 2;
        drivers.push('bulky_items');
      }

      if (fragileItems === 'yes') {
        score += 2;
        drivers.push('fragile_items');
      }

      if (dismantling === 'many') {
        score += 2;
        drivers.push('dismantling_many');
      }

      if (parkingAuthorization === 'unknown') {
        score += 1;
        drivers.push('parking_authorization_unknown');
      }

      if (stairsType === 'narrow') {
        score += 2;
        drivers.push('stairs_narrow');
      }

      if (extraSpaces.includes('cellar') && apartmentSize >= 3.5) {
        score += 1;
        drivers.push('cellar_with_large_flat');
      }

      if (clientHelping === 'yes' && fragileItems === 'yes') {
        score += 1;
        drivers.push('client_helping_fragile');
      }

      if (packedReady === 'no') {
        drivers.push('non_emballe');
      }

      return { score, drivers };
    };

    const mapRiskOutcome = (score: number) => {
      if (score <= 2) return 'auto_quote';
      if (score <= 5) return 'manual_validation';
      if (score <= 7) return 'photos_required';
      return 'human_call';
    };

    const computeSignal = () => {
      const { score, drivers } = computeRiskScore();
      const riskOutcome = mapRiskOutcome(score);
      const level = riskOutcome === 'auto_quote' ? 'green' : riskOutcome === 'manual_validation' ? 'yellow' : 'red';
      const expressEligible = riskOutcome === 'auto_quote';

      return { level, score, drivers, autoAbortReason: '', expressEligible, riskOutcome };
    };

    const syncSignalOutputs = () => {
      if (!form) return;
      const { level, score, drivers, autoAbortReason, expressEligible, riskOutcome } = computeSignal();
      const setHidden = (name: string, value: string) => {
        let el = form.querySelector<HTMLInputElement>(`input[name="${name}"]`);
        if (!el) {
          el = document.createElement('input');
          el.type = 'hidden';
          el.name = name;
          form.appendChild(el);
        }
        el.value = value;
      };

      setHidden('signal_level', level);
      setHidden('signal_score', String(score));
      setHidden('signal_flags', drivers.join('|'));
      setHidden('signal_auto_abort', autoAbortReason || '');
      setHidden('express_eligible', expressEligible ? 'yes' : 'no');
      setHidden('risk_score', String(score));
      setHidden('risk_outcome', riskOutcome);
      setHidden('risk_drivers', drivers.join('|'));
      form.dataset.signal = level;
    };

    const steps = Array.from(
      new Set(Array.from(form?.querySelectorAll('[data-step]') || []).map((el) => el.getAttribute('data-step') || '0'))
    ).sort((a, b) => Number(a) - Number(b));
    const progressFill = form?.querySelector('[data-step-progress-bar] span') as HTMLSpanElement | null;
    const mobileLabel = form?.querySelector('[data-step-mobile-label]') as HTMLElement | null;

    let currentStep = 0;
    let previousStep = 0;
    const prevBtn = form?.querySelector('[data-step-prev]') as HTMLButtonElement | null;
    const nextBtn = form?.querySelector('[data-step-next]') as HTMLButtonElement | null;
    const submitBtn = form?.querySelector('[data-step-submit]') as HTMLButtonElement | null;
    const dots = form?.querySelectorAll('[data-step-dot]') || [];
    const stepLabels = form?.querySelectorAll('[data-step-label]') || [];
    const fieldsContainer = form?.querySelector('[data-stepper-fields]') as HTMLElement | null;
    let maxHeight = 0;

    const setButtonState = (btn: HTMLButtonElement | null, isVisible: boolean, keepSpace = false) => {
      if (!btn) return;
      btn.setAttribute('aria-hidden', (!isVisible).toString());
      if (keepSpace) {
        btn.classList.toggle('invisible', !isVisible);
        btn.classList.toggle('opacity-0', !isVisible);
        btn.classList.toggle('pointer-events-none', !isVisible);
        btn.classList.remove('hidden');
      } else {
        btn.classList.toggle('hidden', !isVisible);
        btn.classList.remove('invisible', 'opacity-0', 'pointer-events-none');
      }
    };

    const updateContainerHeight = () => {
      if (!fieldsContainer) return;
      const currentHeight = fieldsContainer.offsetHeight;
      if (currentHeight > maxHeight) {
        maxHeight = currentHeight;
      }
      fieldsContainer.style.minHeight = `${maxHeight}px`;
    };

    const showStep = (stepIdx: number) => {
      const wrappers = form?.querySelectorAll('[data-step]') || [];
      const direction = stepIdx > previousStep ? 'forward' : 'backward';
      const preserveScroll = window.scrollY;
      wrappers.forEach((el: any) => {
        const step = Number(el.getAttribute('data-step') || 0);
        el.classList.remove('swipe-in-right', 'swipe-in-left', 'swipe-out-left', 'swipe-out-right');

        if (step === stepIdx) {
          el.classList.remove('hidden');
          const enterClass = direction === 'forward' ? 'swipe-in-right' : 'swipe-in-left';
          el.classList.add(enterClass);
          el.addEventListener(
            'animationend',
            () => {
              el.classList.remove(enterClass);
            },
            { once: true }
          );
        } else {
          el.classList.add('hidden');
        }
      });

      dots.forEach((dot: any) => {
        const isActive = dot.getAttribute('data-step') === String(stepIdx);
        dot.classList.toggle('bg-primary/70', isActive);
        dot.classList.toggle('text-black', isActive);
        dot.classList.toggle('border-primary', isActive);
      });
      stepLabels.forEach((label: any) => {
        const isActive = label.getAttribute('data-step-label') === String(stepIdx);
        label.classList.toggle('text-primary', isActive);
        label.classList.toggle('dark:text-white', isActive);
        label.classList.toggle('font-semibold', isActive);
        label.classList.toggle('text-slate-500', !isActive);
        label.classList.toggle('dark:text-slate-300', !isActive);
      });
      setButtonState(prevBtn, stepIdx > 0, true);
      setButtonState(nextBtn, stepIdx < steps.length - 1, true);
      setButtonState(submitBtn, stepIdx >= steps.length - 1);
      form?.setAttribute('data-active-step', String(stepIdx));
      updateProgress(stepIdx);
      applyConditional();
      updateContainerHeight();
      previousStep = stepIdx;
      requestAnimationFrame(() => {
        updateContainerHeight();
        window.scrollTo({ top: preserveScroll });
      });
    };

    const updateProgress = (stepIdx: number) => {
      if (!steps.length) return;
      const ratio = ((stepIdx + 1) / steps.length) * 100;
      if (progressFill) progressFill.style.width = `${Math.max(10, Math.min(100, ratio))}%`;
      if (mobileLabel && stepLabels?.length) {
        const activeLabel = Array.from(stepLabels).find((label) => label.getAttribute('data-step-label') === String(stepIdx));
        mobileLabel.textContent = activeLabel?.textContent || '';
      }
    };

    const validateStep = (stepIdx: number) => {
      applyConditional();
      form?.querySelectorAll('[data-field-wrapper]').forEach((wrapper) => clearFieldError(wrapper as HTMLElement));
      form
        ?.querySelectorAll<HTMLElement>(`[data-step="${stepIdx}"][data-field-wrapper]`)
        .forEach((wrapper) => {
          if ((wrapper as HTMLElement).classList.contains('hidden') || (wrapper as HTMLElement).style.display === 'none')
            return;
          wrapper
            .querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('input, select, textarea')
            .forEach((el) => {
              if (el.dataset.requiredOriginal === 'true') el.required = true;
            });
        });
      let firstInvalid: HTMLElement | null = null;
      let hasError = false;
      const fields =
        form?.querySelectorAll(
          `[data-step="${stepIdx}"] input, [data-step="${stepIdx}"] select, [data-step="${stepIdx}"] textarea`
        ) || [];
      for (const field of fields as any) {
        if (field.dataset.validate === 'ch-phone') {
          const value = (field.value || '').trim();
          const phoneRegex = /^(\+41|0)[\s.-]?\d{2}[\s.-]?\d{3}[\s.-]?\d{2}[\s.-]?\d{2}$/;
          if (value && !phoneRegex.test(value)) {
            field.setCustomValidity('Merci d’entrer un numéro suisse (+41 XX XXX XX XX ou 0XX XXX XX XX).');
          } else {
            field.setCustomValidity('');
          }
        }
        if (field.required && !field.checkValidity()) {
          markFieldError(field);
          hasError = true;
          if (!firstInvalid) firstInvalid = field;
        }
      }
      if (hasError) {
        firstInvalid?.reportValidity();
        return false;
      }
      return true;
    };

    if (form) {
      form.classList.add('is-stepper-ready');
      form.setAttribute('data-active-step', '0');
      updateProgress(0);

      form.querySelectorAll('[data-conditional-source]').forEach((el) => {
        const sourceName = el.getAttribute('data-conditional-source');
        const sourceInputs = form.querySelectorAll(`[name="${sourceName}"], [name="${sourceName}[]"]`);
        sourceInputs.forEach((input) => input.addEventListener('change', applyConditional));
      });

      form.querySelectorAll('[data-validate="ch-phone"]').forEach((input: any) => {
        input.addEventListener('input', () => {
          input.setCustomValidity('');
        });
      });

      form.addEventListener('input', (event) => clearFieldError(event.target as HTMLElement));
      form.addEventListener('change', (event) => {
        clearFieldError(event.target as HTMLElement);
        syncSignalOutputs();
      });

      prevBtn?.addEventListener('click', () => {
        currentStep = Math.max(0, currentStep - 1);
        showStep(currentStep);
      });
      nextBtn?.addEventListener('click', () => {
        applyConditional();
        if (!validateStep(currentStep)) return;
        currentStep = Math.min(steps.length - 1, currentStep + 1);
        showStep(currentStep);
      });

      form.addEventListener('submit', (event) => {
        applyConditional();
        syncSignalOutputs();
        if (!validateStep(currentStep)) {
          event.preventDefault();
        }
      });

      syncSignalOutputs();
      showStep(0);
    }
  });
</script>

<style>
  .conditional-reveal {
    animation: conditionalFlash 1.3s ease;
  }
  :global([data-stepper-fields]) {
    position: relative;
    overflow: hidden;
  }
  @keyframes conditionalFlash {
    0% {
      background-color: rgba(59, 130, 246, 0.15);
    }
    100% {
      background-color: transparent;
    }
  }
  :global([data-field-wrapper].has-error) {
    border-radius: 0.75rem;
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.16);
    animation: errorPulse 1.4s ease-in-out infinite;
  }
  :global(.input-error) {
    border-color: rgb(239 68 68) !important;
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.16);
  }
  @keyframes errorPulse {
    0% {
      background-color: transparent;
    }
    40% {
      background-color: rgba(248, 113, 113, 0.16);
    }
    100% {
      background-color: transparent;
    }
  }
  @keyframes swipeInRight {
    0% {
      opacity: 0.85;
      transform: translateX(60px) rotate(0.8deg) scale(0.98);
    }
    100% {
      opacity: 1;
      transform: translateX(0) rotate(0deg) scale(1);
    }
  }
  @keyframes swipeInLeft {
    0% {
      opacity: 0.85;
      transform: translateX(-60px) rotate(-0.8deg) scale(0.98);
    }
    100% {
      opacity: 1;
      transform: translateX(0) rotate(0deg) scale(1);
    }
  }
  @keyframes swipeOutLeft {
    0% {
      opacity: 1;
      transform: translateX(0) rotate(0deg) scale(1);
    }
    100% {
      opacity: 0.75;
      transform: translateX(-60px) rotate(-0.8deg) scale(0.98);
    }
  }
  @keyframes swipeOutRight {
    0% {
      opacity: 1;
      transform: translateX(0) rotate(0deg) scale(1);
    }
    100% {
      opacity: 0.75;
      transform: translateX(60px) rotate(0.8deg) scale(0.98);
    }
  }
  :global(.swipe-in-right) {
    animation: swipeInRight 260ms cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
  }
  :global(.swipe-in-left) {
    animation: swipeInLeft 260ms cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
  }
  :global(.swipe-out-left) {
    animation: swipeOutLeft 220ms cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
  }
  :global(.swipe-out-right) {
    animation: swipeOutRight 220ms cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
  }
  @media (max-width: 768px) {
    /* Keep only the first step visible until JS hydrates */
    [data-stepper-mobile]:not(.is-stepper-ready) [data-step]:not([data-step='0']) {
      display: none;
    }
    [data-stepper-mobile] .stepper-actions {
      position: sticky;
      bottom: 0;
      padding: 0.75rem 0.25rem 0.5rem;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0.92));
      backdrop-filter: blur(12px);
      z-index: 5;
    }
    :global(.dark [data-stepper-mobile] .stepper-actions) {
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.92));
    }
    [data-stepper-mobile] .stepper-actions button {
      width: 100%;
    }
    [data-stepper-mobile] [data-step-progress] {
      display: none;
    }
    [data-stepper-mobile] [data-stepper-fields] {
      gap: 1.25rem;
    }
  }
</style>
