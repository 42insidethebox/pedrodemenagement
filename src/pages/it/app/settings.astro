---
import BackendLayout from '~/layouts/BackendLayout.astro';
---

<BackendLayout pageTitle="Impostazioni">
  <section class="space-y-8">
    <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Configurazione Supabase</h2>
      <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Aggiungi queste variabili d'ambiente al deployment per attivare il backend.</p>
      <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 dark:border-slate-800 dark:bg-slate-950/70 p-4 text-sm font-mono text-slate-700 dark:text-slate-200">
        <p class="text-xs uppercase tracking-wide text-slate-500">.env</p>
        <pre class="mt-2 whitespace-pre-wrap text-slate-700 dark:text-slate-200">PUBLIC_SUPABASE_URL=&lt;your-project-url&gt;
PUBLIC_SUPABASE_ANON_KEY=&lt;your-anon-key&gt;
SUPABASE_SERVICE_ROLE_KEY=&lt;your-service-role-key&gt;</pre>
      </div>
      <p class="mt-3 text-xs text-slate-500">
        Ruota le chiavi in Supabase → Settings → API. La service role resta solo lato server.
      </p>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Rubrica team</h2>
        <div class="flex items-center gap-2">
          <button id="team-refresh" class="rounded-lg border border-slate-700 px-3 py-1 text-xs text-slate-500 hover:bg-slate-800 dark:text-slate-300">Aggiorna</button>
        </div>
      </div>
      <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
        I profili sono creati automaticamente per i nuovi utenti Supabase e collegati all’agenzia principale. Aggiungi manualmente collaboratori qui sotto usando il loro user id Supabase.
      </p>

      <form id="team-form" class="mt-6 grid gap-4 lg:grid-cols-2">
        <div class="lg:col-span-1">
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="team-user-id">ID utente Supabase</label>
          <input
            id="team-user-id"
            name="user_id"
            required
            placeholder="00000000-0000-4000-8000-000000000000"
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div class="lg:col-span-1">
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="team-full-name">Nome e cognome</label>
          <input
            id="team-full-name"
            name="full_name"
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div class="lg:col-span-1">
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="team-email">Email</label>
          <input
            id="team-email"
            name="email"
            type="email"
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div class="lg:col-span-1">
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="team-role">Ruolo</label>
          <select
            id="team-role"
            name="role"
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          >
            <option value="owner">Owner</option>
            <option value="admin">Admin</option>
            <option value="manager">Manager</option>
            <option value="member" selected>Membro</option>
            <option value="contractor">Collaboratore</option>
          </select>
        </div>
        <div class="lg:col-span-1">
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="team-timezone">Fuso orario</label>
          <input
            id="team-timezone"
            name="timezone"
            placeholder="Europe/Zurich"
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div class="lg:col-span-2 flex items-center gap-3">
          <button id="team-submit" type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-md shadow-blue-500/30 transition hover:bg-blue-500 disabled:cursor-not-allowed disabled:opacity-70">Aggiungi membro</button>
          <p id="team-message" class="text-sm text-slate-500 dark:text-slate-400"></p>
        </div>
      </form>

      <div class="mt-6 overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            <tr>
              <th class="px-4 py-3">Nome</th>
              <th class="px-4 py-3">Email</th>
              <th class="px-4 py-3">Ruolo</th>
              <th class="px-4 py-3">Fuso orario</th>
              <th class="px-4 py-3 text-right">Azioni</th>
            </tr>
          </thead>
          <tbody id="team-table" class="divide-y divide-slate-200 text-slate-700 dark:divide-slate-800 dark:text-slate-200">
            <tr>
              <td colspan="5" class="px-4 py-6 text-center text-sm text-slate-600 dark:text-slate-400">Caricamento team…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Schema del database</h2>
      <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
        Esegui lo SQL in <code class="text-blue-300">supabase/schema.sql</code> sulla tua istanza Supabase per creare tabelle, relazioni e indici usati da questo workspace.
      </p>
      <a href="https://supabase.com/docs/guides/database/connecting" target="_blank" rel="noreferrer" class="mt-4 inline-flex items-center rounded-lg border border-blue-500/40 px-4 py-2 text-sm text-blue-600 hover:bg-blue-500/10 dark:text-blue-400">
        Supabase docs ↗
      </a>
    </div>
  </section>
</BackendLayout>

<script type="module">
  import { authFetch } from '~/utils/backend/api';

  const tableBody = document.getElementById('team-table');
  const refreshButton = document.getElementById('team-refresh');
  const teamForm = document.getElementById('team-form');
  const teamMessage = document.getElementById('team-message');
  const teamSubmit = document.getElementById('team-submit');

  const roleOptions = [
    { value: 'owner', label: 'Owner' },
    { value: 'admin', label: 'Admin' },
    { value: 'manager', label: 'Manager' },
    { value: 'member', label: 'Membro' },
    { value: 'contractor', label: 'Collaboratore' },
  ];

  const renderTeam = (team) => {
    if (!tableBody) return;
    tableBody.innerHTML = '';

    const members = Array.isArray(team) ? team : [];

    if (!members.length) {
      tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-slate-600 dark:text-slate-400">Invita membri tramite Supabase Auth per popolare questa lista.</td></tr>';
      return;
    }

    members.forEach((member) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-4 py-3">
          <div class="font-medium text-slate-900 dark:text-white">${member.full_name ?? '—'}</div>
          <div class="text-xs text-slate-500 dark:text-slate-400">${member.user_id}</div>
        </td>
        <td class="px-4 py-3 text-sm">${member.email ?? '—'}</td>
        <td class="px-4 py-3">
          <select data-role="${member.id}" data-prev="${member.role}" class="rounded-lg border border-slate-300 bg-white px-2 py-1 text-xs text-slate-700 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white">
            ${roleOptions
              .map((option) => `<option value="${option.value}" ${option.value === member.role ? 'selected' : ''}>${option.label}</option>`)
              .join('')}
          </select>
        </td>
        <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-300">${member.timezone ?? '—'}</td>`;
        row.innerHTML += `
        <td class="px-4 py-3 text-right">
          <button type="button" data-delete="${member.id}" class="rounded-lg border border-red-200 px-3 py-1 text-xs text-red-600 transition hover:bg-red-50 dark:border-red-500/40 dark:text-red-300 dark:hover:bg-red-500/10">Rimuovi</button>
        </td>`;
      tableBody.appendChild(row);
    });
  };

  const loadTeam = async () => {
    if (tableBody) {
      tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-slate-600 dark:text-slate-400">Caricamento team…</td></tr>';
    }
    try {
      const response = await authFetch('/team');
      renderTeam(response.team ?? []);
    } catch (error) {
      console.error(error);
      if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-red-400">Unable to load team.</td></tr>';
      }
    }
  };

  teamForm?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!teamForm) return;

    teamMessage?.classList.remove('text-red-400', 'text-blue-600', 'dark:text-blue-400');
    if (teamMessage) teamMessage.textContent = '';

    if (teamSubmit) {
      teamSubmit.disabled = true;
      teamSubmit.classList.add('animate-pulse');
    }

    const formData = new FormData(teamForm);
    const payload = {
      user_id: String(formData.get('user_id') ?? '').trim(),
      full_name: String(formData.get('full_name') ?? '').trim() || null,
      email: String(formData.get('email') ?? '').trim() || null,
      role: String(formData.get('role') ?? 'member'),
      timezone: String(formData.get('timezone') ?? '').trim() || null,
    };

    try {
      if (!payload.user_id) {
        throw new Error('Supabase user id is required');
      }
      await authFetch('/team', {
        method: 'POST',
        body: JSON.stringify(payload),
      });
      if (teamMessage) {
        teamMessage.classList.add('text-blue-600', 'dark:text-blue-400');
        teamMessage.textContent = 'Team member added.';
      }
      teamForm.reset();
      await loadTeam();
    } catch (error) {
      console.error(error);
      if (teamMessage) {
        teamMessage.classList.add('text-red-400');
        teamMessage.textContent = error instanceof Error ? error.message : 'Unable to add team member.';
      }
    } finally {
      if (teamSubmit) {
        teamSubmit.disabled = false;
        teamSubmit.classList.remove('animate-pulse');
      }
    }
  });

  tableBody?.addEventListener('change', async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLSelectElement)) return;
    const memberId = target.getAttribute('data-role');
    if (!memberId) return;

    const previous = target.getAttribute('data-prev') || target.value;
    target.disabled = true;
    target.classList.add('animate-pulse');

    try {
      await authFetch(`/team/${memberId}`, {
        method: 'PATCH',
        body: JSON.stringify({ role: target.value }),
      });
      target.setAttribute('data-prev', target.value);
    } catch (error) {
      console.error(error);
      target.value = previous;
    } finally {
      target.disabled = false;
      target.classList.remove('animate-pulse');
    }
  });

  tableBody?.addEventListener('click', async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;

    const deleteId = target.getAttribute('data-delete');
    if (!deleteId) return;

    target.classList.add('animate-pulse');
    target.disabled = true;

    try {
      await authFetch(`/team/${deleteId}`, {
        method: 'DELETE',
        parseJson: false,
      });
      await loadTeam();
    } catch (error) {
      console.error(error);
    } finally {
      target.classList.remove('animate-pulse');
      target.disabled = false;
    }
  });

  refreshButton?.addEventListener('click', () => {
    loadTeam();
  });

  await loadTeam();
</script>
