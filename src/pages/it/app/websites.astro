---
import BackendLayout from '~/layouts/BackendLayout.astro';
---

<BackendLayout pageTitle="Siti web">
  <section class="space-y-8">
    <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Collega un sito</h2>
      <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
        Cattura l'area di delivery per un sito cliente. I documenti e le cartelle Google vengono creati automaticamente se lasci questi campi vuoti.
      </p>
      <form id="website-form" class="mt-6 grid gap-4 lg:grid-cols-2">
        <div class="lg:col-span-2 grid gap-4 sm:grid-cols-2">
          <div>
            <label class="block text-sm text-slate-600 dark:text-slate-300" for="name">Nome del sito</label>
            <input
              id="name"
              name="name"
              required
              placeholder="Maison Favre – Viticulture"
              class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
            />
          </div>
          <div>
            <label class="block text-sm text-slate-600 dark:text-slate-300" for="client_id">Cliente</label>
            <select
              id="client_id"
              name="client_id"
              class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
            >
              <option value="">Nessun cliente</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="status">Stato</label>
          <select
            id="status"
            name="status"
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          >
            <option value="draft">Bozza</option>
            <option value="content_review">Revisione contenuti</option>
            <option value="ready">Pronto al lancio</option>
            <option value="live">Online</option>
            <option value="paused">In pausa</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="domain">Dominio</label>
          <input
            id="domain"
            name="domain"
            placeholder="clientsite.ch"
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="preview_url">URL di anteprima</label>
          <input
            id="preview_url"
            name="preview_url"
            placeholder="preview.vercel.app"
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="google_doc_id">ID Google Doc (opzionale)</label>
          <input
            id="google_doc_id"
            name="google_doc_id"
            placeholder="Creato automaticamente se vuoto"
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="template_key">Chiave template (opzionale)</label>
          <input
            id="template_key"
            name="template_key"
            placeholder="hero-01"
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div class="lg:col-span-2 flex items-center gap-3">
          <button
            id="website-submit"
            type="submit"
            class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-md shadow-blue-500/30 transition hover:bg-blue-500 disabled:opacity-70"
          >
            Salva sito
          </button>
          <p id="website-message" class="text-sm text-slate-600 dark:text-slate-400"></p>
        </div>
      </form>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Pipeline di consegna</h2>
        <span class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Tempo reale</span>
      </div>
      <div class="mt-6 overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            <tr>
              <th class="px-4 py-3">Sito</th>
              <th class="px-4 py-3">Stato</th>
              <th class="px-4 py-3">Dominio</th>
              <th class="px-4 py-3">Documenti</th>
              <th class="px-4 py-3 text-right">Azioni</th>
            </tr>
          </thead>
          <tbody id="website-table" class="divide-y divide-slate-200 dark:divide-slate-800 text-slate-700 dark:text-slate-200">
            <tr>
              <td colspan="5" class="px-4 py-6 text-center text-sm text-slate-600 dark:text-slate-400">Caricamento siti…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</BackendLayout>

<script type="module">
  import { authFetch } from '~/utils/backend/api';

  const clientSelect = document.getElementById('client_id');
  const form = document.getElementById('website-form');
  const message = document.getElementById('website-message');
  const submitButton = document.getElementById('website-submit');
  const tableBody = document.getElementById('website-table');

  const clientLookup = {};
  let clientOptions = [];
  const websiteCache = new Map();

  const safe = (value) => (value ? String(value) : '—');

  const htmlEscape = (value) =>
    value == null
      ? ''
      : String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

  const resetFeedback = (element) => {
    if (!element) return;
    element.classList.remove('text-red-400', 'text-blue-600', 'dark:text-blue-400');
    element.classList.add('text-slate-500', 'dark:text-slate-400');
    element.textContent = '';
  };

  const showFeedback = (element, text, type = 'neutral') => {
    if (!element) return;
    resetFeedback(element);
    if (type === 'success') {
      element.classList.remove('text-slate-500', 'dark:text-slate-400');
      element.classList.add('text-blue-600', 'dark:text-blue-400');
    } else if (type === 'error') {
      element.classList.remove('text-slate-500', 'dark:text-slate-400');
      element.classList.add('text-red-400');
    }
    element.textContent = text;
  };

  const slugify = (value) =>
    value
      .toLowerCase()
      .normalize('NFKD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)+/g, '')
      .slice(0, 64) || 'section';

  const normalizeOptional = (value) => {
    const normalized = typeof value === 'string' ? value.trim() : '';
    return normalized.length ? normalized : null;
  };

  const renderClientOptions = (selectedId) => {
    const options = ['<option value="">Nessun cliente</option>'];
    let hasSelected = false;
    clientOptions.forEach((client) => {
      const isSelected = client.id === selectedId;
      if (isSelected) hasSelected = true;
      options.push(
        `<option value="${htmlEscape(client.id)}" ${isSelected ? 'selected' : ''}>${htmlEscape(
          client.company_name,
        )}</option>`,
      );
    });
    if (selectedId && !hasSelected) {
      options.push(`<option value="${htmlEscape(selectedId)}" selected>${htmlEscape(selectedId)}</option>`);
    }
    return options.join('');
  };

  const renderSectionEditor = (websiteId, section) => `
    <form
      data-section-form="${htmlEscape(section.id)}"
      data-website="${htmlEscape(websiteId)}"
      class="space-y-3 rounded-lg border border-slate-200 bg-slate-50 px-4 py-4 text-left shadow-sm dark:border-slate-800 dark:bg-slate-950/70"
    >
      <div class="grid gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Chiave sezione</label>
          <input
            name="section_key"
            required
            value="${htmlEscape(section.section_key ?? '')}"
            class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Titolo</label>
          <input
            name="heading"
            value="${htmlEscape(section.heading ?? '')}"
            class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div class="sm:col-span-2">
          <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Contenuto</label>
          <textarea
            name="content"
            rows="3"
            class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm leading-relaxed text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
          >${htmlEscape(section.content ?? '')}</textarea>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Google Doc ID</label>
          <input
            name="google_doc_id"
            value="${htmlEscape(section.google_doc_id ?? '')}"
            class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Titolo doc</label>
          <input
            name="google_doc_heading"
            value="${htmlEscape(section.google_doc_heading ?? '')}"
            class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
          />
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button
          type="submit"
          class="rounded-lg border border-blue-500/50 px-3 py-1 text-xs font-semibold text-blue-600 transition hover:bg-blue-500/10 dark:text-blue-300"
        >
          Salva sezione
        </button>
        <button
          type="button"
          data-section-delete="${htmlEscape(section.id)}"
          data-website="${htmlEscape(websiteId)}"
          class="rounded-lg border border-red-200 px-3 py-1 text-xs text-red-600 transition hover:bg-red-50 dark:border-red-500/40 dark:text-red-300 dark:hover:bg-red-500/10"
        >
          Delete
        </button>
        <p data-feedback class="text-xs text-slate-500 dark:text-slate-400"></p>
      </div>
    </form>
  `;

  const renderWebsiteDetail = (website, sections) => {
    const cached = websiteCache.get(website.id) ?? {};
    const merged = { ...cached, ...website };
    websiteCache.set(website.id, merged);

    const sectionList =
      sections && sections.length
        ? sections.map((section) => renderSectionEditor(website.id, section)).join('')
        : '<p class="rounded-lg border border-dashed border-slate-300 px-4 py-4 text-xs text-slate-500 dark:border-slate-700 dark:text-slate-400">Nessuna sezione registrata. Aggiungine una sotto o sincronizza da Google Docs.</p>';

    return `
      <div class="mt-4 space-y-6" data-sections-container>
        <form data-website-update="${htmlEscape(website.id)}" class="space-y-4 rounded-lg border border-slate-200 bg-slate-50 px-4 py-4 shadow-sm dark:border-slate-800 dark:bg-slate-950/70">
          <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Dettagli sito</h4>
          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Nome</label>
              <input
                name="name"
                required
                value="${htmlEscape(merged.name ?? '')}"
                class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
              />
            </div>
            <div>
              <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Cliente</label>
              <select
                name="client_id"
                class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
              >
                ${renderClientOptions(merged.client_id ?? '')}
              </select>
            </div>
            <div>
              <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Dominio</label>
              <input
                name="domain"
                value="${htmlEscape(merged.domain ?? '')}"
                placeholder="https://example.com"
                class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
              />
            </div>
            <div>
              <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">URL di anteprima</label>
              <input
                name="preview_url"
                value="${htmlEscape(merged.preview_url ?? '')}"
                placeholder="https://preview.vercel.app"
                class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
              />
            </div>
            <div>
              <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">URL di produzione</label>
              <input
                name="production_url"
                value="${htmlEscape(merged.production_url ?? '')}"
                placeholder="https://live.example.com"
                class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
              />
            </div>
            <div>
              <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Chiave template</label>
              <input
                name="template_key"
                value="${htmlEscape(merged.template_key ?? '')}"
                placeholder="hero-01"
                class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
              />
            </div>
            <div>
              <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Google Doc ID</label>
              <input
                name="google_doc_id"
                value="${htmlEscape(merged.google_doc_id ?? '')}"
                placeholder="1A2B3C..."
                class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
              />
            </div>
            <div>
              <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">ID cartella Google</label>
              <input
                name="google_folder_id"
                value="${htmlEscape(merged.google_folder_id ?? '')}"
                placeholder="Drive folder id"
                class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
              />
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button
              type="submit"
              class="rounded-lg bg-blue-600 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-white shadow-sm shadow-blue-500/30 transition hover:bg-blue-500 disabled:opacity-70"
            >
              Salva sito details
            </button>
            <p data-feedback class="text-xs text-slate-500 dark:text-slate-400"></p>
          </div>
        </form>
        <div class="space-y-4 rounded-lg border border-slate-200 bg-white px-4 py-4 shadow-sm dark:border-slate-800 dark:bg-slate-950/60">
          <div class="flex items-center justify-between">
            <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Sezioni</h4>
            <p data-section-global class="text-xs text-slate-500 dark:text-slate-400"></p>
          </div>
          <div data-section-list class="space-y-3">${sectionList}</div>
          <form
            data-section-create="${htmlEscape(website.id)}"
            class="space-y-3 rounded-lg border border-dashed border-slate-300 px-4 py-4 dark:border-slate-700"
          >
            <h5 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Aggiungi sezione</h5>
            <div class="grid gap-3 sm:grid-cols-2">
              <div>
                <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Chiave sezione</label>
                <input
                  name="section_key"
                  placeholder="about-us"
                  class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
                />
              </div>
              <div>
                <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Titolo</label>
                <input
                  name="heading"
                  placeholder="Hero section"
                  class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
                />
              </div>
              <div class="sm:col-span-2">
                <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Contenuto</label>
                <textarea
                  name="content"
                  rows="3"
                  placeholder="Copy, requirements or notes for the section"
                  class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm leading-relaxed text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
                ></textarea>
              </div>
              <div>
                <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Google Doc ID</label>
                <input
                  name="google_doc_id"
                  placeholder="Optional"
                  class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
                />
              </div>
              <div>
                <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Titolo doc</label>
                <input
                  name="google_doc_heading"
                  placeholder="Optional"
                  class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
                />
              </div>
            </div>
            <div class="flex items-center gap-3">
              <button
                type="submit"
                class="rounded-lg bg-blue-600 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-white shadow-sm shadow-blue-500/30 transition hover:bg-blue-500 disabled:opacity-70"
              >
                Aggiungi
              </button>
              <p data-feedback class="text-xs text-slate-500 dark:text-slate-400"></p>
            </div>
          </form>
        </div>
      </div>
    `;
  };

  const renderWebsites = (websites) => {
    if (!tableBody) return;
    tableBody.innerHTML = '';

    if (!websites.length) {
      tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-slate-600 dark:text-slate-400">Nessun sito. Registrane uno sopra.</td></tr>';
      return;
    }

    websites.forEach((website) => {
      websiteCache.set(website.id, website);
      const row = document.createElement('tr');
      row.dataset.id = website.id;
      row.innerHTML = `
        <td class="px-4 py-3 align-top">
          <div data-field="name" class="font-medium text-slate-900 dark:text-white">${safe(website.name)}</div>
          <p data-field="client" class="text-xs text-slate-500 dark:text-slate-400">${
            website.client_id ? clientLookup[website.client_id] || website.client_id : 'No client'
          }</p>
          <button data-toggle="${website.id}" class="mt-2 text-xs text-blue-600 dark:text-blue-400 hover:text-blue-300">Vedi sezioni</button>
          <div class="hidden" data-sections="${website.id}"></div>
        </td>
        <td class="px-4 py-3 align-top">
          <select data-status="${website.id}" class="rounded-lg border border-slate-300 bg-white px-2 py-1 text-xs text-slate-700 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white">
            <option value="draft" ${website.status === 'draft' ? 'selected' : ''}>Bozza</option>
            <option value="content_review" ${website.status === 'content_review' ? 'selected' : ''}>Revisione</option>
            <option value="ready" ${website.status === 'ready' ? 'selected' : ''}>Ready</option>
            <option value="live" ${website.status === 'live' ? 'selected' : ''}>Online</option>
            <option value="paused" ${website.status === 'paused' ? 'selected' : ''}>In pausa</option>
          </select>
        </td>
        <td class="px-4 py-3 align-top">
          <div data-field="domain" class="text-xs text-slate-500 dark:text-slate-300">${
            website.domain
              ? `<a class=\"text-blue-600 dark:text-blue-400 hover:text-blue-300\" href=\"${website.domain}\" target=\"_blank\" rel=\"noreferrer\">${website.domain}</a>`
              : '—'
          }</div>
          <div data-field="preview" class="mt-1 text-xs text-slate-500 dark:text-slate-400">Anteprima: ${
            website.preview_url
              ? `<a class=\"text-blue-600 dark:text-blue-400 hover:text-blue-300\" href=\"${website.preview_url}\" target=\"_blank\" rel=\"noreferrer\">${website.preview_url}</a>`
              : '—'
          }</div>
        </td>
        <td class="px-4 py-3 align-top text-xs text-blue-600 dark:text-blue-400">
          <div data-field="doc-links">
            ${
              website.google_doc_id
                ? `<a class=\"block hover:text-blue-300\" href=\"https://docs.google.com/document/d/${website.google_doc_id}\" target=\"_blank\" rel=\"noreferrer\">Apri doc</a>`
                : '<span class=\"text-slate-400\">Non generato</span>'
            }
            ${
              website.google_folder_id
                ? `<a class=\"mt-1 block hover:text-blue-300\" href=\"https://drive.google.com/drive/folders/${website.google_folder_id}\" target=\"_blank\" rel=\"noreferrer\">Apri cartella</a>`
                : ''
            }
          </div>
        </td>
        <td class="px-4 py-3 text-right align-top">
          <button data-sync="${website.id}" class="mr-2 rounded-lg border border-blue-500/50 px-3 py-1 text-xs text-blue-300 hover:bg-blue-500/10">Sincronizza doc</button>
          <button data-delete="${website.id}" class="rounded-lg border border-red-200 px-3 py-1 text-xs text-red-600 transition hover:bg-red-50 dark:border-red-500/40 dark:text-red-300 dark:hover:bg-red-500/10">Elimina</button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  };

  const updateWebsiteRow = (website) => {
    const row = tableBody?.querySelector(`tr[data-id="${website.id}"]`);
    if (!(row instanceof HTMLElement)) return;

    const cached = websiteCache.get(website.id) ?? {};
    websiteCache.set(website.id, { ...cached, ...website });

    const nameEl = row.querySelector('[data-field="name"]');
    if (nameEl) nameEl.textContent = safe(website.name);

    const clientEl = row.querySelector('[data-field="client"]');
    if (clientEl)
      clientEl.textContent = website.client_id
        ? clientLookup[website.client_id] || website.client_id
        : 'No client';

    const domainEl = row.querySelector('[data-field="domain"]');
    if (domainEl)
      domainEl.innerHTML = website.domain
        ? `<a class="text-blue-600 dark:text-blue-400 hover:text-blue-300" href="${website.domain}" target="_blank" rel="noreferrer">${website.domain}</a>`
        : '—';

    const previewEl = row.querySelector('[data-field="preview"]');
    if (previewEl)
      previewEl.innerHTML = `Anteprima: ${
        website.preview_url
          ? `<a class="text-blue-600 dark:text-blue-400 hover:text-blue-300" href="${website.preview_url}" target="_blank" rel="noreferrer">${website.preview_url}</a>`
          : '—'
      }`;

    const docsEl = row.querySelector('[data-field="doc-links"]');
    if (docsEl)
      docsEl.innerHTML = `
        ${
          website.google_doc_id
            ? `<a class="block hover:text-blue-300" href="https://docs.google.com/document/d/${website.google_doc_id}" target="_blank" rel="noreferrer">Apri doc</a>`
            : '<span class="text-slate-400">Non generato</span>'
        }
        ${
          website.google_folder_id
            ? `<a class="mt-1 block hover:text-blue-300" href="https://drive.google.com/drive/folders/${website.google_folder_id}" target="_blank" rel="noreferrer">Apri cartella</a>`
            : ''
        }
      `;

    const statusSelect = row.querySelector('select[data-status]');
    if (statusSelect instanceof HTMLSelectElement) {
      statusSelect.value = website.status;
      statusSelect.setAttribute('data-prev', website.status);
    }
  };

  const handleWebsiteResponse = (website, sections, options = {}) => {
    updateWebsiteRow(website);
    const row = tableBody?.querySelector(`tr[data-id="${website.id}"]`);
    const container = row?.querySelector(`[data-sections="${website.id}"]`);
    const toggle = row?.querySelector(`[data-toggle="${website.id}"]`);
    if (!(container instanceof HTMLElement)) return;

    const shouldOpen = options.forceOpen || !container.classList.contains('hidden');
    if (!shouldOpen) return;

    container.classList.remove('hidden');
    if (toggle instanceof HTMLElement) toggle.textContent = 'Nascondi sezioni';
    container.innerHTML = renderWebsiteDetail(website, sections ?? []);

    if (options.message) {
      let feedbackTarget = null;
      if (options.focus === 'website') {
        const formEl = container.querySelector(`[data-website-update="${website.id}"]`);
        if (formEl instanceof HTMLElement) feedbackTarget = formEl.querySelector('[data-feedback]');
      } else if (options.focus && typeof options.focus === 'object' && options.focus.sectionId) {
        const sectionForm = container.querySelector(`[data-section-form="${options.focus.sectionId}"]`);
        if (sectionForm instanceof HTMLElement) feedbackTarget = sectionForm.querySelector('[data-feedback]');
      }

      if (!feedbackTarget) {
        feedbackTarget = container.querySelector('[data-section-global]') ?? container.querySelector('[data-feedback]');
      }

      showFeedback(feedbackTarget, options.message, options.type ?? 'neutral');
    }
  };

  const handleWebsiteFormSubmit = async (formElement) => {
    const websiteId = formElement.getAttribute('data-website-update');
    if (!websiteId) return;

    const feedback = formElement.querySelector('[data-feedback]');
    resetFeedback(feedback);
    const submit = formElement.querySelector('button[type="submit"]');
    if (submit) {
      submit.classList.add('animate-pulse');
      submit.disabled = true;
    }

    const formData = new FormData(formElement);
    const name = String(formData.get('name') ?? '').trim();
    if (!name) {
      showFeedback(feedback, 'Nome del sito is required.', 'error');
      if (submit) {
        submit.classList.remove('animate-pulse');
        submit.disabled = false;
      }
      return;
    }

    const payload = {
      name,
      client_id: normalizeOptional(formData.get('client_id')),
      domain: normalizeOptional(formData.get('domain')),
      preview_url: normalizeOptional(formData.get('preview_url')),
      production_url: normalizeOptional(formData.get('production_url')),
      template_key: normalizeOptional(formData.get('template_key')),
      google_doc_id: normalizeOptional(formData.get('google_doc_id')),
      google_folder_id: normalizeOptional(formData.get('google_folder_id')),
    };

    try {
      const response = await authFetch(`/websites/${websiteId}`, {
        method: 'PATCH',
        body: JSON.stringify(payload),
      });
      handleWebsiteResponse(response.website, response.sections ?? [], {
        message: 'Sito aggiornato.',
        type: 'success',
        focus: 'website',
        forceOpen: true,
      });
    } catch (error) {
      console.error(error);
      showFeedback(feedback, error instanceof Error ? error.message : 'Impossibile aggiornare il sito.', 'error');
    } finally {
      if (submit) {
        submit.classList.remove('animate-pulse');
        submit.disabled = false;
      }
    }
  };

  const handleSectionFormSubmit = async (formElement) => {
    const sectionId = formElement.getAttribute('data-section-form');
    const websiteId = formElement.getAttribute('data-website');
    if (!sectionId || !websiteId) return;

    const feedback = formElement.querySelector('[data-feedback]');
    resetFeedback(feedback);
    const submit = formElement.querySelector('button[type="submit"]');
    if (submit) {
      submit.classList.add('animate-pulse');
      submit.disabled = true;
    }

    const formData = new FormData(formElement);
    const heading = normalizeOptional(formData.get('heading'));
    const sectionKeyRaw = String(formData.get('section_key') ?? '').trim();
    const sectionKey = sectionKeyRaw ? slugify(sectionKeyRaw) : slugify(heading ?? `section-${Date.now()}`);
    const payload = {
      sections: [
        {
          id: sectionId,
          section_key: sectionKey,
          heading,
          content: normalizeOptional(formData.get('content')),
          google_doc_id: normalizeOptional(formData.get('google_doc_id')),
          google_doc_heading: normalizeOptional(formData.get('google_doc_heading')),
        },
      ],
    };

    try {
      const response = await authFetch(`/websites/${websiteId}`, {
        method: 'PATCH',
        body: JSON.stringify(payload),
      });
      handleWebsiteResponse(response.website, response.sections ?? [], {
        message: 'Sezione salvata.',
        type: 'success',
        focus: { sectionId },
        forceOpen: true,
      });
    } catch (error) {
      console.error(error);
      showFeedback(feedback, error instanceof Error ? error.message : 'Impossibile salvare la sezione.', 'error');
    } finally {
      if (submit) {
        submit.classList.remove('animate-pulse');
        submit.disabled = false;
      }
    }
  };

  const handleSectionCreate = async (formElement) => {
    const websiteId = formElement.getAttribute('data-section-create');
    if (!websiteId) return;

    const feedback = formElement.querySelector('[data-feedback]');
    resetFeedback(feedback);
    const submit = formElement.querySelector('button[type="submit"]');
    if (submit) {
      submit.classList.add('animate-pulse');
      submit.disabled = true;
    }

    const formData = new FormData(formElement);
    const heading = normalizeOptional(formData.get('heading'));
    const sectionKeyRaw = String(formData.get('section_key') ?? '').trim();
    const sectionKey = sectionKeyRaw ? slugify(sectionKeyRaw) : slugify(heading ?? `section-${Date.now()}`);
    const payload = {
      sections: [
        {
          section_key: sectionKey,
          heading,
          content: normalizeOptional(formData.get('content')),
          google_doc_id: normalizeOptional(formData.get('google_doc_id')),
          google_doc_heading: normalizeOptional(formData.get('google_doc_heading')),
          media: [],
        },
      ],
    };

    try {
      const response = await authFetch(`/websites/${websiteId}`, {
        method: 'PATCH',
        body: JSON.stringify(payload),
      });
      formElement.reset();
      handleWebsiteResponse(response.website, response.sections ?? [], {
        message: 'Section added.',
        type: 'success',
        forceOpen: true,
      });
    } catch (error) {
      console.error(error);
      showFeedback(feedback, error instanceof Error ? error.message : 'Failed to add section.', 'error');
    } finally {
      if (submit) {
        submit.classList.remove('animate-pulse');
        submit.disabled = false;
      }
    }
  };

  const loadClients = async () => {
    if (!clientSelect) return;
    try {
      const response = await authFetch('/clients');
      const clients = response.clients ?? [];
      clientOptions = clients;
      clientSelect.innerHTML = '<option value="">Nessun cliente</option>';
      clients.forEach((client) => {
        clientLookup[client.id] = client.company_name;
        clientSelect.innerHTML += `<option value="${client.id}">${client.company_name}</option>`;
      });
    } catch (error) {
      console.error(error);
      clientSelect.innerHTML = '<option value="">Impossibile caricare i clienti</option>';
    }
  };

  const loadWebsites = async () => {
    if (tableBody) {
      tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-slate-600 dark:text-slate-400">Caricamento siti…</td></tr>';
    }
    try {
      const response = await authFetch('/websites');
      renderWebsites(response.websites ?? []);
    } catch (error) {
      console.error(error);
      if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-red-400">Impossibile caricare i siti.</td></tr>';
      }
    }
  };

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!form) return;
    if (message) {
      message.classList.remove('text-red-400', 'text-blue-600', 'dark:text-blue-400');
      message.textContent = '';
    }
    submitButton?.classList.add('animate-pulse');
    if (submitButton) submitButton.disabled = true;

    const formData = new FormData(form);
    const name = String(formData.get('name') ?? '').trim();
    const payload = {
      name,
      client_id: normalizeOptional(formData.get('client_id')),
      status: String(formData.get('status') ?? 'draft'),
      domain: normalizeOptional(formData.get('domain')),
      preview_url: normalizeOptional(formData.get('preview_url')),
      google_doc_id: normalizeOptional(formData.get('google_doc_id')),
      template_key: normalizeOptional(formData.get('template_key')),
    };

    if (!payload.name) {
      if (message) {
        message.classList.add('text-red-400');
        message.textContent = 'Nome del sito is required.';
      }
      submitButton?.classList.remove('animate-pulse');
      if (submitButton) submitButton.disabled = false;
      return;
    }

    try {
      await authFetch('/websites', {
        method: 'POST',
        body: JSON.stringify(payload),
      });
      if (message) {
        message.classList.add('text-blue-600', 'dark:text-blue-400');
        message.textContent = 'Website captured. Google workspace ready.';
      }
      form.reset();
      await loadWebsites();
    } catch (error) {
      console.error(error);
      if (message) {
        message.classList.add('text-red-400');
        message.textContent = error instanceof Error ? error.message : 'Failed to save website.';
      }
    } finally {
      submitButton?.classList.remove('animate-pulse');
      if (submitButton) submitButton.disabled = false;
    }
  });

  tableBody?.addEventListener('change', async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLSelectElement)) return;
    const id = target.getAttribute('data-status');
    if (!id) return;

    try {
      const response = await authFetch(`/websites/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ status: target.value }),
      });
      handleWebsiteResponse(response.website, response.sections ?? [], {
        message: 'Status updated.',
        type: 'success',
      });
    } catch (error) {
      console.error(error);
      target.value = target.getAttribute('data-prev') || 'draft';
    }
    target.setAttribute('data-prev', target.value);
  });

  tableBody?.addEventListener('submit', async (event) => {
    const formElement = event.target;
    if (!(formElement instanceof HTMLFormElement)) return;
    event.preventDefault();

    if (formElement.hasAttribute('data-website-update')) {
      await handleWebsiteFormSubmit(formElement);
      return;
    }

    if (formElement.hasAttribute('data-section-form')) {
      await handleSectionFormSubmit(formElement);
      return;
    }

    if (formElement.hasAttribute('data-section-create')) {
      await handleSectionCreate(formElement);
    }
  });

  tableBody?.addEventListener('click', async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;

    const deleteId = target.getAttribute('data-delete');
    if (deleteId) {
      target.classList.add('animate-pulse');
      try {
        await authFetch(`/websites/${deleteId}`, { method: 'DELETE', parseJson: false });
        await loadWebsites();
      } catch (error) {
        console.error(error);
      }
      return;
    }

    const toggleId = target.getAttribute('data-toggle');
    if (toggleId) {
      const row = target.closest('tr');
      const container = row?.querySelector(`[data-sections="${toggleId}"]`);
      if (!(container instanceof HTMLElement)) return;
      if (!container.classList.contains('hidden')) {
        container.classList.add('hidden');
        container.innerHTML = '';
        target.textContent = 'Vedi sezioni';
        return;
      }
      container.classList.remove('hidden');
      target.textContent = 'Nascondi sezioni';
      container.innerHTML = '<p class="mt-4 text-xs text-slate-500 dark:text-slate-400">Loading sections…</p>';
      try {
        const response = await authFetch(`/websites/${toggleId}`);
        handleWebsiteResponse(response.website, response.sections ?? [], { forceOpen: true });
      } catch (error) {
        console.error(error);
        container.innerHTML = '<p class="mt-4 text-xs text-red-400">Unable to load sections.</p>';
      }
      return;
    }

    const sectionDeleteId = target.getAttribute('data-section-delete');
    if (sectionDeleteId) {
      const websiteId = target.getAttribute('data-website');
      if (!websiteId) return;
      target.classList.add('animate-pulse');
      try {
        const response = await authFetch(`/websites/${websiteId}`, {
          method: 'PATCH',
          body: JSON.stringify({ sections: [{ id: sectionDeleteId, action: 'delete' }] }),
        });
        handleWebsiteResponse(response.website, response.sections ?? [], {
          message: 'Section removed.',
          type: 'success',
          forceOpen: true,
        });
      } catch (error) {
        console.error(error);
        const row = target.closest('tr');
        const container = row?.querySelector(`[data-sections="${websiteId}"]`);
        const sectionForm = container?.querySelector(`[data-section-form="${sectionDeleteId}"]`);
        const feedback = sectionForm?.querySelector('[data-feedback]') ?? container?.querySelector('[data-section-global]');
        if (feedback) {
          showFeedback(feedback, error instanceof Error ? error.message : 'Impossibile eliminare la sezione.', 'error');
        }
      } finally {
        target.classList.remove('animate-pulse');
      }
      return;
    }

    const syncId = target.getAttribute('data-sync');
    if (syncId) {
      target.classList.add('animate-pulse');
      try {
        const response = await authFetch(`/websites/${syncId}`, {
          method: 'PATCH',
          body: JSON.stringify({ syncFromDoc: true }),
        });
        handleWebsiteResponse(response.website, response.sections ?? [], {
          message: 'Sections synced from Google Doc.',
          type: 'success',
          forceOpen: true,
        });
      } catch (error) {
        console.error(error);
      } finally {
        target.classList.remove('animate-pulse');
      }
    }
  });

  await loadClients();
  await loadWebsites();
</script>
