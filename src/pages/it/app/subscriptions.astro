---
import BackendLayout from '~/layouts/BackendLayout.astro';
---

<BackendLayout pageTitle="Abbonamenti">
  <section class="space-y-8">
    <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Gestisci un abbonamento</h2>
      <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Inserisci un ID abbonamento Stripe per annullare o aggiornare.</p>
      <form id="sub-form" class="mt-6 grid gap-4 lg:grid-cols-3">
        <div class="lg:col-span-1">
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="subscription_id">ID abbonamento</label>
          <input
            id="subscription_id"
            name="subscription_id"
            required
            placeholder="sub_..."
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div class="lg:col-span-1">
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="price_id">Nuovo prezzo (opzionale)</label>
          <input
            id="price_id"
            name="price_id"
            placeholder="price_..."
            class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
          />
        </div>
        <div class="lg:col-span-1 flex items-end gap-3">
          <label class="inline-flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300"
            ><input
              id="cancel_at_period_end"
              type="checkbox"
              class="rounded border-slate-300 bg-white text-blue-600 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white"
            />
            Annulla a fine periodo</label
          >
        </div>
        <div class="lg:col-span-3 flex items-center gap-3">
          <button id="update-btn" type="button" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-md shadow-blue-500/30 transition hover:bg-blue-500">Aggiorna</button>
          <button id="cancel-btn" type="button" class="rounded-lg border border-red-500 px-4 py-2 text-sm font-semibold text-red-300 hover:bg-red-500/10">Annulla subito</button>
          <p id="sub-message" class="text-sm text-slate-600 dark:text-slate-400"></p>
        </div>
      </form>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
        <div>
          <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Eventi abbonamento</h2>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Controlla i webhook Stripe e i cambi di stato registrati dal backend.</p>
          <p id="events-error" class="mt-2 hidden text-sm text-red-500"></p>
        </div>
        <form id="sub-filters" class="grid w-full gap-3 sm:grid-cols-2 lg:grid-cols-5">
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400" for="filter-subscription">Abbonamento</label>
            <input
              id="filter-subscription"
              name="subscription"
              placeholder="sub_..."
              class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
            />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400" for="filter-email">Email cliente</label>
            <input
              id="filter-email"
              name="email"
              type="email"
              placeholder="client@brand.ch"
              class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
            />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400" for="filter-event-type">Tipo evento</label>
            <input
              id="filter-event-type"
              name="eventType"
              placeholder="customer.subscription.updated"
              class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
            />
          </div>
          <div>
            <label class="block text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400" for="filter-search">Search</label>
            <input
              id="filter-search"
              name="search"
              placeholder="Cerca nel payload"
              class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
            />
          </div>
          <div class="flex items-end gap-2">
            <label class="flex flex-1 items-center gap-2 text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Dimensione pagina
              <select
                id="events-page-size"
                class="flex-1 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"
              >
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </label>
            <button type="submit" class="rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm shadow-blue-500/40 transition hover:bg-blue-500">Applica</button>
            <button id="events-refresh" type="button" class="rounded-lg border border-slate-300 px-3 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-100 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800">Aggiorna</button>
          </div>
        </form>
      </div>

      <div class="mt-6 overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            <tr>
              <th class="px-4 py-3">Creato</th>
              <th class="px-4 py-3">Abbonamento</th>
              <th class="px-4 py-3">Cliente</th>
              <th class="px-4 py-3">Evento</th>
              <th class="px-4 py-3 text-right">Payload</th>
            </tr>
          </thead>
          <tbody id="sub-events-body" class="divide-y divide-slate-200 text-slate-700 dark:divide-slate-800 dark:text-slate-200">
            <tr>
              <td colspan="5" class="px-4 py-6 text-center text-sm text-slate-600 dark:text-slate-400">Caricamento eventi…</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <p id="events-pagination" class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Nessun evento</p>
        <div class="flex gap-2">
          <button
            id="events-prev"
            type="button"
            class="rounded-lg border border-slate-300 px-3 py-2 text-xs font-semibold text-slate-600 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800"
            disabled
          >
            Precedente
          </button>
          <button
            id="events-next"
            type="button"
            class="rounded-lg border border-slate-300 px-3 py-2 text-xs font-semibold text-slate-600 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800"
            disabled
          >
            Successivo
          </button>
        </div>
      </div>
    </div>
  </section>
</BackendLayout>

<script type="module">
  import { authFetch } from '~/utils/backend/api';

  const subIdEl = document.getElementById('subscription_id');
  const priceIdEl = document.getElementById('price_id');
  const cancelAtEl = document.getElementById('cancel_at_period_end');
  const updateBtn = document.getElementById('update-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const message = document.getElementById('sub-message');
  const filterForm = document.getElementById('sub-filters');
  const filterSubscription = document.getElementById('filter-subscription');
  const filterEmail = document.getElementById('filter-email');
  const filterEventType = document.getElementById('filter-event-type');
  const filterSearch = document.getElementById('filter-search');
  const pageSizeSelect = document.getElementById('events-page-size');
  const eventsRefresh = document.getElementById('events-refresh');
  const eventsTableBody = document.getElementById('sub-events-body');
  const eventsPagination = document.getElementById('events-pagination');
  const eventsPrev = document.getElementById('events-prev');
  const eventsSuccessivo = document.getElementById('events-next');
  const eventsError = document.getElementById('events-error');

  let eventsPage = 1;
  let eventsTotalPages = 0;

  function setMessage(text, ok = true) {
    if (!message) return;
    message.classList.remove('text-red-400', 'text-blue-600', 'dark:text-blue-400');
    message.classList.add(ok ? 'text-blue-600 dark:text-blue-400' : 'text-red-400');
    message.textContent = text;
  }

  const escapeHtml = (value) =>
    String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

  const formatDateTime = (value) => {
    if (!value) return '—';
    try {
      return new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(value));
    } catch (error) {
      console.error('Unable to format datetime', error);
      return value;
    }
  };

  const updatePagination = () => {
    if (eventsPagination) {
      if (!eventsTotalPages) {
        eventsPagination.textContent = 'Nessun evento';
      } else {
        eventsPagination.textContent = `Page ${eventsPage} of ${eventsTotalPages}`;
      }
    }
    if (eventsPrev) {
      eventsPrev.disabled = eventsPage <= 1;
    }
    if (eventsSuccessivo) {
      eventsSuccessivo.disabled = !eventsTotalPages || eventsPage >= eventsTotalPages;
    }
  };

  const renderEvents = (events) => {
    if (!eventsTableBody) return;
    eventsTableBody.innerHTML = '';

    if (!Array.isArray(events) || events.length === 0) {
      eventsTableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-slate-600 dark:text-slate-400">No subscription events recorded yet.</td></tr>';
      return;
    }

    events.forEach((event) => {
      const row = document.createElement('tr');
      const payload = event?.payload ? escapeHtml(JSON.stringify(event.payload, null, 2)) : '{}';
      row.innerHTML = `
        <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-300">${formatDateTime(event.created_at)}</td>
        <td class="px-4 py-3 text-xs font-mono text-slate-500 dark:text-slate-400">${event.subscription_id ?? '—'}</td>
        <td class="px-4 py-3">
          <div class="text-sm text-slate-700 dark:text-slate-200">${event.customer_email ?? '—'}</div>
        </td>
        <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-300">${event.event_type ?? '—'}</td>
        <td class="px-4 py-3 text-right">
          <button type="button" data-payload="${event.id}" class="rounded-lg border border-slate-300 px-3 py-1 text-xs text-slate-600 transition hover:bg-slate-100 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800">View payload</button>
          <div class="mt-2 hidden text-left" data-payload-container="${event.id}">
            <pre class="whitespace-pre-wrap break-words rounded-lg border border-slate-200 bg-slate-50 p-3 text-[11px] leading-relaxed text-slate-600 dark:border-slate-800 dark:bg-slate-950/70 dark:text-slate-300">${payload}</pre>
          </div>
        </td>
      `;
      eventsTableBody.appendChild(row);
    });
  };

  const buildEventParams = (page = 1) => {
    const params = new URLSearchParams();
    params.set('page', String(page));
    const size = pageSizeSelect instanceof HTMLSelectElement ? Number(pageSizeSelect.value) : 25;
    params.set('pageSize', Number.isNaN(size) || size <= 0 ? '25' : String(size));
    const subscription = filterSubscription instanceof HTMLInputElement ? filterSubscription.value.trim() : '';
    const email = filterEmail instanceof HTMLInputElement ? filterEmail.value.trim() : '';
    const eventType = filterEventType instanceof HTMLInputElement ? filterEventType.value.trim() : '';
    const search = filterSearch instanceof HTMLInputElement ? filterSearch.value.trim() : '';
    if (subscription) params.set('subscriptionId', subscription);
    if (email) params.set('email', email);
    if (eventType) params.set('eventType', eventType);
    if (search) params.set('search', search);
    return params;
  };

  const loadEvents = async (page = 1) => {
    if (!eventsTableBody) return;
    eventsTableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-slate-600 dark:text-slate-400">Caricamento eventi…</td></tr>';
    if (eventsError) {
      eventsError.textContent = '';
      eventsError.classList.add('hidden');
    }

    try {
      const params = buildEventParams(page);
      const response = await authFetch(`/subscriptions?${params.toString()}`);
      renderEvents(response.events ?? []);
      eventsPage = Math.max(1, response.pagination?.page ?? page);
      eventsTotalPages = Math.max(0, response.pagination?.totalPages ?? 0);
      updatePagination();
    } catch (error) {
      console.error(error);
      eventsPage = 1;
      eventsTotalPages = 0;
      updatePagination();
      if (eventsTableBody) {
        eventsTableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-red-400">Unable to load subscription events.</td></tr>';
      }
      if (eventsError) {
        eventsError.textContent = error instanceof Error ? error.message : 'Unable to load subscription events.';
        eventsError.classList.remove('hidden');
      }
    }
  };

  updateBtn?.addEventListener('click', async () => {
    const id = subIdEl?.value?.trim();
    if (!id) return setMessage('Enter a subscription id', false);
    const payload = {};
    if (priceIdEl?.value?.trim()) payload.priceId = priceIdEl.value.trim();
    if (cancelAtEl?.checked) payload.cancelAtPeriodEnd = true;
    else payload.cancelAtPeriodEnd = false;
    try {
      await authFetch(`/subscriptions/${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
      setMessage('Subscription updated');
      await loadEvents(eventsPage);
    } catch (e) {
      console.error(e);
      setMessage(e instanceof Error ? e.message : 'Failed to update', false);
    }
  });

  cancelBtn?.addEventListener('click', async () => {
    const id = subIdEl?.value?.trim();
    if (!id) return setMessage('Enter a subscription id', false);
    try {
      await authFetch(`/subscriptions/${id}`, { method: 'DELETE', parseJson: false });
      setMessage('Subscription canceled');
      await loadEvents(eventsPage);
    } catch (e) {
      console.error(e);
      setMessage(e instanceof Error ? e.message : 'Failed to cancel', false);
    }
  });

  filterForm?.addEventListener('submit', async (event) => {
    event.preventDefault();
    eventsPage = 1;
    await loadEvents(eventsPage);
  });

  pageSizeSelect?.addEventListener('change', async () => {
    eventsPage = 1;
    await loadEvents(eventsPage);
  });

  eventsRefresh?.addEventListener('click', async () => {
    await loadEvents(eventsPage);
  });

  eventsPrev?.addEventListener('click', async () => {
    if (eventsPage <= 1) return;
    eventsPage -= 1;
    await loadEvents(eventsPage);
  });

  eventsSuccessivo?.addEventListener('click', async () => {
    if (!eventsTotalPages || eventsPage >= eventsTotalPages) return;
    eventsPage += 1;
    await loadEvents(eventsPage);
  });

  eventsTableBody?.addEventListener('click', (event) => {
    const target = event.target instanceof HTMLElement ? event.target : null;
    if (!target) return;
    const payloadId = target.getAttribute('data-payload');
    if (!payloadId) return;
    const container = eventsTableBody.querySelector(`[data-payload-container="${payloadId}"]`);
    if (!(container instanceof HTMLElement)) return;
    const isHidden = container.classList.toggle('hidden');
    target.textContent = isHidden ? 'View payload' : 'Hide payload';
  });

  await loadEvents(eventsPage);
</script>
