---
import BackendLayout from '~/layouts/BackendLayout.astro';
---

<BackendLayout pageTitle="Orders">
  <section class="space-y-8">
    <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-slate-950/40">
        <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Total orders</p>
        <p id="metric-total" class="mt-3 text-3xl font-semibold text-slate-900 dark:text-white">—</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Rolling window based on API query.</p>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-slate-950/40">
        <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Recurring subscriptions</p>
        <p id="metric-recurring" class="mt-3 text-3xl font-semibold text-slate-900 dark:text-white">—</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Active or recently created subscription checkouts.</p>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-slate-950/40">
        <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Collected revenue</p>
        <p id="metric-revenue" class="mt-3 text-3xl font-semibold text-emerald-600 dark:text-emerald-400">—</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Sum of paid checkouts in the current view.</p>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-slate-950/40">
        <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Latest order</p>
        <div class="mt-3 text-sm text-slate-600 dark:text-slate-300">
          <p id="metric-latest-email" class="font-medium">—</p>
          <p id="metric-latest-date" class="mt-1 text-xs text-slate-500 dark:text-slate-400">Awaiting data…</p>
        </div>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Order history</h2>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Query Supabase orders recorded by Stripe webhooks.</p>
          <p id="orders-error" class="mt-2 hidden text-sm text-red-500"></p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <label class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
            Status
            <select id="status-filter" class="rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white">
              <option value="">All</option>
              <option value="paid">Paid</option>
              <option value="open">Open</option>
              <option value="complete">Complete</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </label>
          <label class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
            Limit
            <select id="limit-filter" class="rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </label>
          <button id="refresh-orders" class="rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm shadow-blue-500/40 transition hover:bg-blue-500">Refresh</button>
          <button id="export-csv" class="rounded-lg border border-slate-300 px-3 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-100 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800">Export CSV</button>
        </div>
      </div>

      <div class="mt-6 overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            <tr>
              <th class="px-4 py-3">Created</th>
              <th class="px-4 py-3">Order #</th>
              <th class="px-4 py-3">Customer</th>
              <th class="px-4 py-3">Plan &amp; template</th>
              <th class="px-4 py-3">Amount</th>
              <th class="px-4 py-3">Mode</th>
              <th class="px-4 py-3">Status</th>
              <th class="px-4 py-3">Stripe session</th>
              <th class="px-4 py-3">Subscription</th>
              <th class="px-4 py-3 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="orders-table" class="divide-y divide-slate-200 text-slate-700 dark:divide-slate-800 dark:text-slate-200">
            <tr>
              <td colspan="10" class="px-4 py-6 text-center text-sm text-slate-500 dark:text-slate-400">Loading orders…</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="order-detail" class="mt-6 hidden rounded-xl border border-slate-200 bg-slate-50 p-6 text-sm text-slate-600 dark:border-slate-800 dark:bg-slate-900/60 dark:text-slate-300">
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold text-slate-900 dark:text-white">Order details</h3>
          <button id="close-detail" class="rounded-lg border border-slate-300 px-3 py-1 text-xs uppercase tracking-wide text-slate-500 transition hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800">Close</button>
        </div>
        <dl id="order-detail-body" class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3"></dl>
      </div>
    </div>
  </section>
</BackendLayout>

<script type="module">
  import { authFetch } from '~/utils/backend/api';

  const statusFilter = document.getElementById('status-filter');
  const limitFilter = document.getElementById('limit-filter');
  const refreshButton = document.getElementById('refresh-orders');
  const exportButton = document.getElementById('export-csv');
  const tableBody = document.getElementById('orders-table');
  const errorLabel = document.getElementById('orders-error');
  const metricTotal = document.getElementById('metric-total');
  const metricRecurring = document.getElementById('metric-recurring');
  const metricRevenue = document.getElementById('metric-revenue');
  const metricLatestEmail = document.getElementById('metric-latest-email');
  const metricLatestDate = document.getElementById('metric-latest-date');
  const detailPanel = document.getElementById('order-detail');
  const detailBody = document.getElementById('order-detail-body');
  const closeDetail = document.getElementById('close-detail');
  const stripeDashboardBase =
    typeof window !== 'undefined' && window.location.hostname.endsWith('tonsiteweb.ch')
      ? 'https://dashboard.stripe.com'
      : 'https://dashboard.stripe.com/test';

  const statusOptions = [
    { value: 'draft', label: 'Draft' },
    { value: 'open', label: 'Open' },
    { value: 'processing', label: 'Processing' },
    { value: 'requires_action', label: 'Requires action' },
    { value: 'paid', label: 'Paid' },
    { value: 'complete', label: 'Complete' },
    { value: 'cancelled', label: 'Cancelled' },
    { value: 'refunded', label: 'Refunded' },
    { value: 'failed', label: 'Failed' },
  ];

  let cachedOrders = [];

  const formatCurrency = (amount, currency = 'CHF') => {
    if (!amount) return '—';
    try {
      return new Intl.NumberFormat(undefined, {
        style: 'currency',
        currency,
        currencyDisplay: 'symbol',
      }).format(amount / 100);
    } catch (error) {
      console.error('Unable to format currency', error);
      return `${(amount / 100).toFixed(2)} ${currency}`;
    }
  };

  const formatDate = (value) => {
    if (!value) return '—';
    try {
      return new Intl.DateTimeFormat(undefined, {
        dateStyle: 'medium',
        timeStyle: 'short',
      }).format(new Date(value));
    } catch (error) {
      console.error('Unable to format date', error);
      return value;
    }
  };

  const renderMetrics = (metrics) => {
    if (!metrics) return;
    if (metricTotal) metricTotal.textContent = metrics.count?.toString() ?? '0';
    if (metricRecurring) metricRecurring.textContent = metrics.recurringCount?.toString() ?? '0';
    if (metricRevenue) metricRevenue.textContent = formatCurrency(metrics.revenue || 0);
    if (metrics.latest) {
      const parts = [];
      if (metrics.latest.order_number) parts.push(`#${metrics.latest.order_number}`);
      if (metrics.latest.customer_email) parts.push(metrics.latest.customer_email);
      if (metricLatestEmail) metricLatestEmail.textContent = parts.join(' • ') || 'Unknown customer';
      if (metricLatestDate) metricLatestDate.textContent = formatDate(metrics.latest.created_at);
    } else {
      if (metricLatestEmail) metricLatestEmail.textContent = '—';
      if (metricLatestDate) metricLatestDate.textContent = 'Awaiting data…';
    }
  };

  const renderTable = (orders) => {
    if (!tableBody) return;
    tableBody.innerHTML = '';

    if (!orders.length) {
      tableBody.innerHTML = '<tr><td colspan="10" class="px-4 py-6 text-center text-sm text-slate-500 dark:text-slate-400">No orders found for this filter.</td></tr>';
      return;
    }

    orders.forEach((order) => {
      const row = document.createElement('tr');
      row.className = 'transition hover:bg-slate-50 dark:hover:bg-slate-800/40';
      const stripeUrl = (() => {
        if (order.mode === 'subscription' && order.subscription_id) {
          return `${stripeDashboardBase}/subscriptions/${order.subscription_id}`;
        }
        if (order.stripe_session_id) {
          return `${stripeDashboardBase}/checkouts/sessions/${order.stripe_session_id}`;
        }
        return '';
      })();
      const stripeLink = stripeUrl
        ? `<a class="rounded-lg border border-blue-200 px-3 py-1 text-xs text-blue-600 transition hover:bg-blue-50 dark:border-blue-500/40 dark:text-blue-300 dark:hover:bg-blue-500/10" href="${stripeUrl}" target="_blank" rel="noopener">Stripe</a>`
        : '';
      const plan = order.plan || order.metadata?.plan || '—';
      const template = order.template_key || order.metadata?.template || '—';
      const normalizedStatusRaw = String(order.status || 'open').toLowerCase();
      const normalizedStatus = normalizedStatusRaw === 'canceled' ? 'cancelled' : normalizedStatusRaw;
      const statusSelect = `
        <select data-status="${order.id}" data-prev="${normalizedStatus}" class="rounded-lg border border-slate-300 bg-white px-2 py-1 text-xs text-slate-700 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-700 dark:bg-slate-950 dark:text-white">
          ${statusOptions
            .map((option) => `<option value="${option.value}" ${normalizedStatus === option.value ? 'selected' : ''}>${option.label}</option>`)
            .join('')}
        </select>
      `;
      row.innerHTML = `
        <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-300">${formatDate(order.created_at)}</td>
        <td class="px-4 py-3 text-xs font-mono text-slate-500 dark:text-slate-400">${order.order_number ?? '—'}</td>
        <td class="px-4 py-3">
          <div class="font-medium text-slate-900 dark:text-white">${order.customer_email ?? 'Unknown'}</div>
          <div class="text-xs text-slate-500 dark:text-slate-400">${order.customer_name ?? ''}</div>
        </td>
        <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-300">
          <div class="font-medium text-slate-700 dark:text-slate-200">${plan || '—'}</div>
          <div class="mt-1 text-[11px] uppercase tracking-wide text-slate-400 dark:text-slate-500">${template || '—'}</div>
        </td>
        <td class="px-4 py-3 text-sm">${formatCurrency(order.amount_total, order.currency || 'CHF')}</td>
        <td class="px-4 py-3 text-xs capitalize text-slate-500 dark:text-slate-400">${order.mode ?? '—'}</td>
        <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-300">${statusSelect}</td>
        <td class="px-4 py-3 text-xs font-mono text-slate-500 dark:text-slate-400">${order.stripe_session_id ?? '—'}</td>
        <td class="px-4 py-3 text-xs font-mono text-slate-500 dark:text-slate-400">${order.subscription_id ?? '—'}</td>
        <td class="px-4 py-3 text-right">
          <div class="flex justify-end gap-2">
            <button class="rounded-lg border border-red-200 px-3 py-1 text-xs text-red-600 transition hover:bg-red-50 dark:border-red-500/40 dark:text-red-300 dark:hover:bg-red-500/10" data-delete="${order.id}">Delete</button>
            <button class="rounded-lg border border-slate-300 px-3 py-1 text-xs text-slate-600 transition hover:bg-slate-100 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800" data-action="detail" data-id="${order.id}">Details</button>
            ${stripeLink}
          </div>
        </td>
      `;
      tableBody.appendChild(row);
    });
  };

  const renderDetail = (order) => {
    if (!detailPanel || !detailBody) return;
    if (!order) {
      detailPanel.classList.add('hidden');
      detailBody.innerHTML = '';
      return;
    }

    const rows = [
      ['Order ID', order.id],
      ['Order number', order.order_number || '—'],
      ['Created at', formatDate(order.created_at)],
      ['Customer email', order.customer_email || '—'],
      ['Customer name', order.customer_name || '—'],
      ['Company', order.company || order.metadata?.company || '—'],
      ['Phone', order.phone || order.metadata?.phone || '—'],
      ['Plan', order.plan || order.metadata?.plan || '—'],
      ['Template', order.template_key || order.metadata?.template || '—'],
      ['Stripe session', order.stripe_session_id || '—'],
      ['Subscription ID', order.subscription_id || '—'],
      ['Mode', order.mode || '—'],
      ['Status', order.status || '—'],
      ['Amount', formatCurrency(order.amount_total, order.currency || 'CHF')],
      ['Currency', order.currency || '—'],
      ['Metadata', JSON.stringify(order.metadata ?? {}, null, 2)],
    ];

    detailBody.innerHTML = rows
      .map(
        ([label, value]) => `
          <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-950/60">
            <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">${label}</dt>
            <dd class="mt-2 whitespace-pre-wrap break-words text-sm text-slate-700 dark:text-slate-200">${value ?? '—'}</dd>
          </div>
        `,
      )
      .join('');

    detailPanel.classList.remove('hidden');
  };

  const exportAsCsv = () => {
    if (!cachedOrders.length) {
      alert('No orders to export. Refresh first.');
      return;
    }
    const header = [
      'id',
      'order_number',
      'created_at',
      'customer_email',
      'customer_name',
      'company',
      'phone',
      'plan',
      'template_key',
      'amount_total',
      'currency',
      'mode',
      'status',
      'stripe_session_id',
      'subscription_id',
      'metadata',
    ];
    const rows = [header.join(',')];
    cachedOrders.forEach((order) => {
      const values = header.map((key) => {
        const value = order[key] ?? '';
        if (typeof value === 'string') {
          return `"${value.replace(/"/g, '""')}"`;
        }
        if (typeof value === 'number') {
          return value;
        }
        if (typeof value === 'object' && value !== null) {
          const json = JSON.stringify(value);
          return `"${json.replace(/"/g, '""')}"`;
        }
        return value;
      });
      rows.push(values.join(','));
    });
    const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `orders-${new Date().toISOString()}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const loadOrders = async () => {
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="10" class="px-4 py-6 text-center text-sm text-slate-500 dark:text-slate-400">Loading orders…</td></tr>';
    if (errorLabel) {
      errorLabel.textContent = '';
      errorLabel.classList.add('hidden');
    }

    try {
      const params = new URLSearchParams();
      if (statusFilter?.value) params.set('status', statusFilter.value);
      if (limitFilter?.value) params.set('limit', limitFilter.value);
      const response = await authFetch(`/orders?${params.toString()}`);
      cachedOrders = response.orders ?? [];
      renderTable(cachedOrders);
      renderMetrics(response.metrics);
    } catch (error) {
      console.error(error);
      if (errorLabel) {
        errorLabel.textContent = error instanceof Error ? error.message : 'Unable to load orders';
        errorLabel.classList.remove('hidden');
      }
      tableBody.innerHTML = '<tr><td colspan="10" class="px-4 py-6 text-center text-sm text-red-400">Failed to load orders.</td></tr>';
    }
  };

  statusFilter?.addEventListener('change', () => {
    renderDetail(null);
    loadOrders();
  });

  limitFilter?.addEventListener('change', () => {
    renderDetail(null);
    loadOrders();
  });

  refreshButton?.addEventListener('click', () => {
    renderDetail(null);
    loadOrders();
  });

  exportButton?.addEventListener('click', () => {
    exportAsCsv();
  });

  tableBody?.addEventListener('change', async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLSelectElement)) return;
    const orderId = target.getAttribute('data-status');
    if (!orderId) return;

    const previousValue = target.getAttribute('data-prev') || '';
    target.classList.add('animate-pulse');
    try {
      const response = await authFetch(`/orders/${orderId}`, {
        method: 'PATCH',
        body: JSON.stringify({ status: target.value }),
      });
      const updatedStatusRaw = response?.order?.status ? String(response.order.status).toLowerCase() : target.value.toLowerCase();
      const normalized = updatedStatusRaw === 'canceled' ? 'cancelled' : updatedStatusRaw;
      target.setAttribute('data-prev', normalized);
      await loadOrders();
      renderDetail(null);
    } catch (error) {
      console.error(error);
      target.value = previousValue || target.value;
      if (errorLabel) {
        errorLabel.textContent = error instanceof Error ? error.message : 'Unable to update order';
        errorLabel.classList.remove('hidden');
      }
    } finally {
      target.classList.remove('animate-pulse');
    }
  });

  tableBody?.addEventListener('click', async (event) => {
    const target = event.target instanceof HTMLElement ? event.target : null;
    if (!target) return;

    const deleteButton = target.closest('[data-delete]');
    if (deleteButton instanceof HTMLElement) {
      const deleteId = deleteButton.getAttribute('data-delete');
      if (!deleteId) return;
      deleteButton.classList.add('animate-pulse');
      try {
        await authFetch(`/orders/${deleteId}`, { method: 'DELETE', parseJson: false });
        renderDetail(null);
        await loadOrders();
      } catch (error) {
        console.error(error);
        if (errorLabel) {
          errorLabel.textContent = error instanceof Error ? error.message : 'Unable to delete order';
          errorLabel.classList.remove('hidden');
        }
      } finally {
        deleteButton.classList.remove('animate-pulse');
      }
      return;
    }

    const detailButton = target.closest('[data-action="detail"]');
    if (!(detailButton instanceof HTMLElement)) return;
    const id = detailButton.getAttribute('data-id');
    const order = cachedOrders.find((item) => String(item.id) === id);
    if (order) {
      renderDetail(order);
      detailPanel?.scrollIntoView({ behavior: 'smooth' });
    }
  });

  closeDetail?.addEventListener('click', () => {
    renderDetail(null);
  });

  loadOrders();
</script>

