---
import BackendLayout from '~/layouts/BackendLayout.astro';
---

<BackendLayout pageTitle="Support">
  <section class="space-y-8">
    <div class="rounded-2xl border border-slate-800 bg-slate-900/40 px-6 py-6 shadow-lg shadow-slate-950/40">
      <h2 class="text-lg font-semibold text-white">Raise a client request</h2>
      <p class="mt-2 text-sm text-slate-400">
        Every request generates a traceable ticket, triggers an email to support@tonsiteweb.ch and keeps history for billing.
      </p>
      <form id="support-form" class="mt-6 grid gap-4 lg:grid-cols-2">
        <div>
          <label class="block text-sm text-slate-300" for="website_id">Website (optional)</label>
          <select
            id="website_id"
            name="website_id"
            class="mt-2 w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
          >
            <option value="">General request</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-300" for="customer_name">Customer name</label>
          <input
            id="customer_name"
            name="customer_name"
            placeholder="Claire – Maison Favre"
            class="mt-2 w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
          />
        </div>
        <div>
          <label class="block text-sm text-slate-300" for="customer_email">Customer email</label>
          <input
            id="customer_email"
            name="customer_email"
            type="email"
            placeholder="client@entreprise.ch"
            class="mt-2 w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
          />
        </div>
        <div>
          <label class="block text-sm text-slate-300" for="request_type">Request type</label>
          <select
            id="request_type"
            name="request_type"
            class="mt-2 w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
          >
            <option value="content_change">Content change</option>
            <option value="design">Design update</option>
            <option value="bug">Bug / issue</option>
            <option value="upgrade">Upgrade</option>
            <option value="billing">Billing question</option>
            <option value="general">General support</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-300" for="priority">Priority</label>
          <select
            id="priority"
            name="priority"
            class="mt-2 w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
          >
            <option value="normal">Normal</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="lg:col-span-2">
          <label class="block text-sm text-slate-300" for="description">Description</label>
          <textarea
            id="description"
            name="description"
            rows="4"
            required
            placeholder="Client would like to replace hero background image and update services section."
            class="mt-2 w-full rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
          ></textarea>
        </div>
        <div class="lg:col-span-2 flex items-center gap-3">
          <button
            id="support-submit"
            type="submit"
            class="rounded-lg bg-blue-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-blue-500/30 transition hover:bg-blue-400 disabled:opacity-70"
          >
            Log request
          </button>
          <p id="support-message" class="text-sm text-slate-400"></p>
        </div>
      </form>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/40 px-6 py-6 shadow-lg shadow-slate-950/40">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white">Ticket backlog</h2>
        <span class="text-xs uppercase tracking-wide text-slate-400">Auto-sync</span>
      </div>
      <div class="mt-6 overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead class="text-xs uppercase tracking-wide text-slate-400">
            <tr>
              <th class="px-4 py-3">Ticket</th>
              <th class="px-4 py-3">Type</th>
              <th class="px-4 py-3">Priority</th>
              <th class="px-4 py-3">Status</th>
              <th class="px-4 py-3 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="support-table" class="divide-y divide-slate-800 text-slate-200">
            <tr>
              <td colspan="5" class="px-4 py-6 text-center text-sm text-slate-400">Loading support tickets…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</BackendLayout>

<script type="module">
  import { authFetch } from '~/utils/backend/api';

  const websiteSelect = document.getElementById('website_id');
  const form = document.getElementById('support-form');
  const message = document.getElementById('support-message');
  const submitButton = document.getElementById('support-submit');
  const tableBody = document.getElementById('support-table');

  const websiteLookup = {};

  const safe = (value) => (value ? String(value) : '—');

  const renderTickets = (tickets) => {
    if (!tableBody) return;
    tableBody.innerHTML = '';

    if (!tickets.length) {
      tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-slate-400">No tickets yet. Log one above.</td></tr>';
      return;
    }

    tickets.forEach((ticket) => {
      const row = document.createElement('tr');
      row.dataset.id = ticket.id;
      row.innerHTML = `
        <td class="px-4 py-3 align-top">
          <div class="font-medium text-white">${safe(ticket.description)}</div>
          <p class="mt-1 text-xs text-slate-400">${ticket.customer_name || 'Client TonSiteWeb'} – ${ticket.customer_email || '—'}</p>
          <p class="mt-1 text-xs text-slate-500">${ticket.website_id ? websiteLookup[ticket.website_id] || ticket.website_id : 'General request'}</p>
        </td>
        <td class="px-4 py-3 align-top text-xs text-slate-300 capitalize">${safe(ticket.request_type)}</td>
        <td class="px-4 py-3 align-top text-xs text-slate-300 capitalize">${safe(ticket.priority)}</td>
        <td class="px-4 py-3 align-top text-xs">
          <select data-status="${ticket.id}" class="rounded-lg border border-slate-700 bg-slate-950 px-2 py-1 text-xs text-white">
            <option value="open" ${ticket.status === 'open' ? 'selected' : ''}>Open</option>
            <option value="in_progress" ${ticket.status === 'in_progress' ? 'selected' : ''}>In progress</option>
            <option value="waiting" ${ticket.status === 'waiting' ? 'selected' : ''}>Waiting</option>
            <option value="resolved" ${ticket.status === 'resolved' ? 'selected' : ''}>Resolved</option>
            <option value="closed" ${ticket.status === 'closed' ? 'selected' : ''}>Closed</option>
          </select>
        </td>
        <td class="px-4 py-3 text-right align-top">
          <button data-close="${ticket.id}" class="mr-2 rounded-lg border border-emerald-500/50 px-3 py-1 text-xs text-emerald-300 hover:bg-emerald-500/10">Mark resolved</button>
          <button data-delete="${ticket.id}" class="rounded-lg border border-red-500/50 px-3 py-1 text-xs text-red-300 hover:bg-red-500/10">Delete</button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  };

  const loadWebsites = async () => {
    if (!websiteSelect) return;
    try {
      const response = await authFetch('/websites');
      const websites = response.websites ?? [];
      websiteSelect.innerHTML = '<option value="">General request</option>';
      websites.forEach((website) => {
        websiteLookup[website.id] = website.name;
        websiteSelect.innerHTML += `<option value="${website.id}">${website.name}</option>`;
      });
    } catch (error) {
      console.error(error);
      websiteSelect.innerHTML = '<option value="">Unable to load websites</option>';
    }
  };

  const loadTickets = async () => {
    if (tableBody) {
      tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-slate-400">Loading support tickets…</td></tr>';
    }
    try {
      const response = await authFetch('/support');
      renderTickets(response.requests ?? []);
    } catch (error) {
      console.error(error);
      if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-red-400">Unable to load support pipeline.</td></tr>';
      }
    }
  };

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!form) return;
    message?.classList.remove('text-red-400', 'text-blue-400');
    if (message) message.textContent = '';
    submitButton?.classList.add('animate-pulse');
    if (submitButton) submitButton.disabled = true;

    const formData = new FormData(form);
    const payload = {
      website_id: String(formData.get('website_id') ?? '') || null,
      customer_name: String(formData.get('customer_name') ?? '').trim() || null,
      customer_email: String(formData.get('customer_email') ?? '').trim() || null,
      request_type: String(formData.get('request_type') ?? 'general'),
      priority: String(formData.get('priority') ?? 'normal'),
      description: String(formData.get('description') ?? '').trim(),
    };

    try {
      await authFetch('/support', {
        method: 'POST',
        body: JSON.stringify(payload),
      });
      if (message) {
        message.classList.add('text-blue-400');
        message.textContent = 'Ticket logged and support notified.';
      }
      form.reset();
      await loadTickets();
    } catch (error) {
      console.error(error);
      if (message) {
        message.classList.add('text-red-400');
        message.textContent = error instanceof Error ? error.message : 'Unable to log ticket.';
      }
    } finally {
      submitButton?.classList.remove('animate-pulse');
      if (submitButton) submitButton.disabled = false;
    }
  });

  tableBody?.addEventListener('change', async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLSelectElement)) return;
    const id = target.getAttribute('data-status');
    if (!id) return;

    try {
      await authFetch(`/support/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ status: target.value }),
      });
    } catch (error) {
      console.error(error);
      target.value = target.getAttribute('data-prev') || 'open';
    }
    target.setAttribute('data-prev', target.value);
  });

  tableBody?.addEventListener('click', async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;

    const deleteId = target.getAttribute('data-delete');
    if (deleteId) {
      target.classList.add('animate-pulse');
      try {
        await authFetch(`/support/${deleteId}`, { method: 'DELETE', parseJson: false });
        await loadTickets();
      } catch (error) {
        console.error(error);
      }
      return;
    }

    const closeId = target.getAttribute('data-close');
    if (closeId) {
      target.classList.add('animate-pulse');
      try {
        await authFetch(`/support/${closeId}`, {
          method: 'PATCH',
          body: JSON.stringify({ status: 'resolved' }),
        });
        await loadTickets();
      } catch (error) {
        console.error(error);
      } finally {
        target.classList.remove('animate-pulse');
      }
    }
  });

  await loadWebsites();
  await loadTickets();
</script>
