---
import BackendLayout from '~/layouts/BackendLayout.astro';
---

<BackendLayout pageTitle="Tableau de bord">
  <section class="space-y-6">
    <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Indicateurs clés</h2>
    <div class="grid gap-5 sm:grid-cols-2 xl:grid-cols-5">
      <article class="rounded-2xl border border-slate-200 bg-white px-5 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40" data-metric="clients">
        <p class="text-sm text-slate-600 dark:text-slate-400">Clients actifs</p>
        <p class="mt-3 text-3xl font-semibold text-slate-900 dark:text-white" data-value>--</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-500">Segmentez vos clients d’agence.</p>
      </article>
      <article class="rounded-2xl border border-slate-200 bg-white px-5 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40" data-metric="projects">
        <p class="text-sm text-slate-600 dark:text-slate-400">Projets en cours</p>
        <p class="mt-3 text-3xl font-semibold text-slate-900 dark:text-white" data-value>--</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-500">Suivez la livraison sans tableurs.</p>
      </article>
      <article class="rounded-2xl border border-slate-200 bg-white px-5 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40" data-metric="websites">
        <p class="text-sm text-slate-600 dark:text-slate-400">Sites en ligne</p>
        <p class="mt-3 text-3xl font-semibold text-slate-900 dark:text-white" data-value>--</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-500">Comptage des sites en production.</p>
      </article>
      <article class="rounded-2xl border border-slate-200 bg-white px-5 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40" data-metric="outstanding">
        <p class="text-sm text-slate-600 dark:text-slate-400">Factures en attente</p>
        <p class="mt-3 text-3xl font-semibold text-slate-900 dark:text-white" data-value>$0</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-500">Suivez le cash à encaisser.</p>
      </article>
      <article class="rounded-2xl border border-slate-200 bg-white px-5 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40" data-metric="revenue">
        <p class="text-sm text-slate-600 dark:text-slate-400">Revenu (30 jours)</p>
        <p class="mt-3 text-3xl font-semibold text-slate-900 dark:text-white" data-value>$0</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-500">Total facturé récemment.</p>
      </article>
    </div>
  </section>

  <section class="mt-10 grid gap-6 lg:grid-cols-3">
    <div class="lg:col-span-2 space-y-6">
      <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Santé des tâches</h2>
          <span class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Sync temps réel</span>
        </div>
        <dl class="mt-6 space-y-4">
          <div>
            <dt class="flex items-center justify-between text-sm text-slate-600 dark:text-slate-300">
              <span>En retard</span>
              <span data-task-count="overdue">0</span>
            </dt>
            <div class="mt-2 h-2 rounded-full bg-slate-200 dark:bg-slate-800">
              <div class="h-2 rounded-full bg-red-500" data-task-bar="overdue" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <dt class="flex items-center justify-between text-sm text-slate-600 dark:text-slate-300">
              <span>Bloquées</span>
              <span data-task-count="blocked">0</span>
            </dt>
            <div class="mt-2 h-2 rounded-full bg-slate-200 dark:bg-slate-800">
              <div class="h-2 rounded-full bg-amber-400" data-task-bar="blocked" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <dt class="flex items-center justify-between text-sm text-slate-600 dark:text-slate-300">
              <span>En cours</span>
              <span data-task-count="inProgress">0</span>
            </dt>
            <div class="mt-2 h-2 rounded-full bg-slate-200 dark:bg-slate-800">
              <div class="h-2 rounded-full bg-blue-500" data-task-bar="inProgress" style="width: 0%"></div>
            </div>
          </div>
        </dl>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Documents récents</h2>
          <a href="/app/documents" class="text-sm text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300">Gérer</a>
        </div>
        <ul class="mt-6 space-y-4" id="document-list">
          <li class="text-sm text-slate-600 dark:text-slate-400">Aucun document. Ajoutez des propositions ou rapports.</li>
        </ul>
      </div>
    </div>

    <div class="space-y-6">
      <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Activité</h2>
          <span class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">10 dernières</span>
        </div>
        <ol class="mt-6 space-y-4" id="activity-feed">
          <li class="text-sm text-slate-600 dark:text-slate-400">L’activité apparaîtra au fur et à mesure.</li>
        </ol>
      </div>
    </div>
  </section>
</BackendLayout>

<script type="module">
  import { authFetch } from '~/utils/backend/api';

  const metricCards = document.querySelectorAll('[data-metric]');
  const taskCounts = {
    overdue: document.querySelector('[data-task-count="overdue"]'),
    blocked: document.querySelector('[data-task-count="blocked"]'),
    inProgress: document.querySelector('[data-task-count="inProgress"]'),
  };
  const taskBars = {
    overdue: document.querySelector('[data-task-bar="overdue"]'),
    blocked: document.querySelector('[data-task-bar="blocked"]'),
    inProgress: document.querySelector('[data-task-bar="inProgress"]'),
  };
  const documentList = document.getElementById('document-list');
  const activityFeed = document.getElementById('activity-feed');

  const formatCurrency = (value) =>
    new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(Number(value ?? 0));

  const setMetric = (key, value) => {
    const card = Array.from(metricCards).find((element) => element.getAttribute('data-metric') === key);
    const valueElement = card?.querySelector('[data-value]');
    if (valueElement) {
      valueElement.textContent = value;
    }
  };

  const renderTasks = (tasks) => {
    const dataset = tasks && typeof tasks === 'object' ? tasks : {};
    const total = Object.values(dataset).reduce((acc, cur) => acc + Number(cur ?? 0), 0);
    Object.entries(dataset).forEach(([key, count]) => {
      const countEl = taskCounts[key];
      const barEl = taskBars[key];
      if (countEl) countEl.textContent = String(count ?? 0);
      if (barEl) {
        const numericCount = Number(count ?? 0);
        const percentage = total === 0 ? 0 : Math.min(100, Math.round((numericCount / total) * 100));
        barEl.style.width = `${percentage}%`;
      }
    });
  };

  const renderDocuments = (docs) => {
    if (!documentList) return;
    documentList.innerHTML = '';

    if (!Array.isArray(docs) || docs.length === 0) {
      documentList.innerHTML = '<li class="text-sm text-slate-600 dark:text-slate-400">Aucun document. Ajoutez des propositions ou rapports.</li>';
      return;
    }

    docs.forEach((doc) => {
      const item = document.createElement('li');
      item.className = 'rounded-xl border border-slate-200 bg-slate-50 px-4 py-4 text-sm text-slate-700 dark:border-slate-800 dark:bg-slate-950/60 dark:text-slate-200';
      item.innerHTML = `<div class="flex items-center justify-between"><span class="font-medium text-slate-900 dark:text-white">${doc.title}</span><span class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">${doc.document_type}</span></div><p class="mt-2 text-xs text-slate-500 dark:text-slate-400">${doc.status}</p>`;
      documentList.appendChild(item);
    });
  };

  const renderActivities = (activities) => {
    if (!activityFeed) return;
    activityFeed.innerHTML = '';

    if (!Array.isArray(activities) || activities.length === 0) {
      activityFeed.innerHTML = '<li class="text-sm text-slate-600 dark:text-slate-400">L’activité apparaîtra au fur et à mesure.</li>';
      return;
    }

    activities.forEach((activity) => {
      const item = document.createElement('li');
      item.className = 'rounded-xl border border-slate-200 bg-slate-50 px-4 py-4 text-sm text-slate-700 dark:border-slate-800 dark:bg-slate-950/60 dark:text-slate-200';
      const timestamp = activity.created_at ? new Date(activity.created_at).toLocaleString() : '';
      item.innerHTML = `<div class="flex items-center justify-between"><span class="font-medium text-slate-900 dark:text-white">${activity.action}</span><span class="text-xs text-slate-500 dark:text-slate-400">${timestamp}</span></div><p class="mt-2 text-xs text-slate-500 dark:text-slate-400">${activity.entity_type ?? ''} → ${activity.entity_id ?? ''}</p>`;
      activityFeed.appendChild(item);
    });
  };

  try {
    const data = await authFetch('/dashboard/summary');

    setMetric('clients', String(data.metrics.clients ?? 0));
    setMetric('projects', String(data.metrics.activeProjects ?? 0));
    setMetric('websites', String(data.metrics.liveWebsites ?? 0));
    setMetric('outstanding', formatCurrency(data.metrics.outstandingAmount ?? 0));
    setMetric('revenue', formatCurrency(data.metrics.revenueLast30Days ?? 0));

    renderTasks(data.tasks ?? {});
    renderDocuments(data.documents ?? []);
    renderActivities(data.activities ?? []);
  } catch (error) {
    console.error(error);
  }
</script>
