---
import BackendLayout from '~/layouts/BackendLayout.astro';
---

<BackendLayout pageTitle="Aufgaben">
  <section class="space-y-8">
    <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Aufgabe erstellen</h2>
      <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Ordnen Sie Deliverables Projekten und Verantwortlichen mit Fälligkeiten zu.</p>
      <form id="task-form" class="mt-6 grid gap-4 lg:grid-cols-2">
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="title">Titel</label>
          <input id="title" name="title" required class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white" />
        </div>
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="project_id">Projekt</label>
          <select id="project_id" name="project_id" required class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white">
            <option value="">Projekte werden geladen…</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="assignee_id">Zuständig</label>
          <select id="assignee_id" name="assignee_id" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white">
            <option value="">Nicht zugewiesen</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="status">Status</label>
          <select id="status" name="status" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white">
            <option value="todo">Offen</option>
            <option value="in_progress">In Arbeit</option>
            <option value="blocked">Blockiert</option>
            <option value="done">Erledigt</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="priority">Priorität</label>
          <select id="priority" name="priority" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white">
            <option value="low">Niedrig</option>
            <option value="medium">Mittel</option>
            <option value="high">Hoch</option>
            <option value="urgent">Dringend</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="due_date">Fällig am</label>
          <input id="due_date" name="due_date" type="date" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white" />
        </div>
        <div class="lg:col-span-2">
          <label class="block text-sm text-slate-600 dark:text-slate-300" for="description">Beschreibung</label>
          <textarea id="description" name="description" rows="3" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/40 dark:border-slate-800 dark:bg-slate-950 dark:text-white"></textarea>
        </div>
        <div class="lg:col-span-2 flex items-center gap-3">
          <button id="task-submit" type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-md shadow-blue-500/30 transition hover:bg-blue-500 disabled:cursor-not-allowed disabled:opacity-70">Aufgabe speichern</button>
          <p id="task-message" class="text-sm text-slate-500 dark:text-slate-400"></p>
        </div>
      </form>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/40 dark:shadow-lg dark:shadow-slate-950/40">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Ausführungstafel</h2>
        <span class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Operativer Überblick</span>
      </div>
      <div class="mt-6 overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            <tr>
              <th class="px-4 py-3">Aufgabe</th>
              <th class="px-4 py-3">Projekt</th>
              <th class="px-4 py-3">Zuständig</th>
              <th class="px-4 py-3">Status</th>
              <th class="px-4 py-3">Priorität</th>
              <th class="px-4 py-3">Fällig</th>
              <th class="px-4 py-3 text-right">Aktionen</th>
            </tr>
          </thead>
          <tbody id="task-table" class="divide-y divide-slate-200 text-slate-700 dark:divide-slate-800 dark:text-slate-200">
            <tr>
              <td colspan="7" class="px-4 py-6 text-center text-sm text-slate-500 dark:text-slate-400">Aufgaben werden geladen…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</BackendLayout>

<script type="module">
  import { authFetch } from '~/utils/backend/api';

  const form = document.getElementById('task-form');
  const message = document.getElementById('task-message');
  const submitButton = document.getElementById('task-submit');
  const tableBody = document.getElementById('task-table');
  const projectSelect = document.getElementById('project_id');
  const assigneeSelect = document.getElementById('assignee_id');

  const projectLookup = {};
  const teamLookup = {};

  const loadProjects = async () => {
    if (!projectSelect) return;
      projectSelect.innerHTML = '<option value="">Projekte werden geladen…</option>';
    Object.keys(projectLookup).forEach((key) => delete projectLookup[key]);
    try {
      const response = await authFetch('/projects');
      const projects = response.projects ?? [];
      if (!projects.length) {
      projectSelect.innerHTML = '<option value="">Fügen Sie zuerst ein Projekt hinzu</option>';
        return;
      }
      projectSelect.innerHTML = projects
        .map((project) => {
          projectLookup[project.id] = project.name;
          return `<option value="${project.id}">${project.name}</option>`;
        })
        .join('');
    } catch (error) {
      console.error(error);
      projectSelect.innerHTML = '<option value="">Projekte können nicht geladen werden</option>';
    }
  };

  const loadTeam = async () => {
    if (!assigneeSelect) return;
    assigneeSelect.innerHTML = '<option value="">Nicht zugewiesen</option>';
    Object.keys(teamLookup).forEach((key) => delete teamLookup[key]);
    try {
      const response = await authFetch('/team');
      const members = response.team ?? [];
      members.forEach((member) => {
        teamLookup[member.user_id] = member.full_name ?? member.user_id;
      });
      assigneeSelect.innerHTML = '<option value="">Nicht zugewiesen</option>' +
        members
          .map((member) => `<option value="${member.user_id}">${member.full_name ?? member.user_id}</option>`)
          .join('');
    } catch (error) {
      console.error(error);
    }
  };

  const renderTasks = (tasks) => {
    if (!tableBody) return;
    tableBody.innerHTML = '';

    if (!tasks.length) {
      tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-sm text-slate-500 dark:text-slate-400">Noch keine Aufgaben. Planen Sie eine oben.</td></tr>';
      return;
    }

    tasks.forEach((task) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-4 py-3">
          <div class="font-medium text-slate-900 dark:text-white">${task.title}</div>
          <div class="text-xs text-slate-500 dark:text-slate-400">${task.description ?? ''}</div>
        </td>
        <td class="px-4 py-3 text-sm">${projectLookup[task.project_id] ?? task.project_id ?? ''}</td>
        <td class="px-4 py-3 text-sm">${teamLookup[task.assignee_id] ?? '—'}</td>
        <td class="px-4 py-3"><span class="inline-flex rounded-full bg-slate-100 px-2.5 py-1 text-xs capitalize text-slate-700 dark:bg-slate-800 dark:text-slate-200">${task.status}</span></td>
        <td class="px-4 py-3"><span class="inline-flex rounded-full bg-slate-50 px-2.5 py-1 text-xs capitalize text-slate-700 dark:bg-slate-800/60 dark:text-slate-200">${task.priority}</span></td>
        <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-300">${task.due_date ? new Date(task.due_date).toLocaleDateString() : '—'}</td>
        <td class="px-4 py-3 text-right">
          <button data-delete="${task.id}" class="rounded-lg border border-red-200 px-3 py-1 text-xs text-red-600 transition hover:bg-red-50 dark:border-red-500/40 dark:text-red-300 dark:hover:bg-red-500/10">Löschen</button>
        </td>`;
      tableBody.appendChild(row);
    });
  };

  const loadTasks = async () => {
    try {
      const response = await authFetch('/tasks');
      renderTasks(response.tasks ?? []);
    } catch (error) {
      console.error(error);
      if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-sm text-red-400">Aufgaben können nicht geladen werden.</td></tr>';
      }
    }
  };

  if (form) {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (message) {
        message.classList.remove('text-red-400', 'text-blue-600', 'dark:text-blue-400');
        message.textContent = '';
      }
      if (submitButton) {
        submitButton.classList.add('animate-pulse');
        submitButton.disabled = true;
      }

      const formData = new FormData(form);
      const payload = {
        title: String(formData.get('title') ?? '').trim(),
        project_id: String(formData.get('project_id') ?? ''),
        assignee_id: String(formData.get('assignee_id') ?? '') || null,
        status: String(formData.get('status') ?? 'todo'),
        priority: String(formData.get('priority') ?? 'medium'),
        due_date: String(formData.get('due_date') ?? '') || null,
        description: String(formData.get('description') ?? '').trim() || null,
      };

      try {
        await authFetch('/tasks', {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        if (message) {
          message.classList.add('text-blue-600', 'dark:text-blue-400');
          message.textContent = 'Aufgabe gespeichert.';
        }
        form.reset();
        await loadTasks();
      } catch (error) {
        console.error(error);
        if (message) {
          message.classList.add('text-red-400');
          message.textContent = error instanceof Error ? error.message : 'Aufgabe konnte nicht gespeichert werden.';
        }
      } finally {
        if (submitButton) {
          submitButton.classList.remove('animate-pulse');
          submitButton.disabled = false;
        }
      }
    });
  }

  if (tableBody) {
    tableBody.addEventListener('click', async (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const deleteId = target.getAttribute('data-delete');
      if (!deleteId) return;

      target.classList.add('animate-pulse');
      try {
        await authFetch(`/tasks/${deleteId}`, {
          method: 'DELETE',
          parseJson: false,
        });
        await loadTasks();
      } catch (error) {
        console.error(error);
      }
    });
  }

  await loadProjects();
  await loadTeam();
  await loadTasks();
</script>
