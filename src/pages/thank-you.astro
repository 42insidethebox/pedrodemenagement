---
import Layout from '~/layouts/PageLayout.astro';

const SUPPORTED_LOCALES = ['fr', 'en', 'it', 'de'] as const;

function resolveLocale() {
  const query = Astro.url.searchParams.get('lang');
  if (query && SUPPORTED_LOCALES.includes(query.toLowerCase() as any)) return query.toLowerCase() as typeof SUPPORTED_LOCALES[number];
  const header = Astro.request.headers.get('accept-language') || '';
  const [raw] = header.split(',');
  if (raw) {
    const base = raw.split(';')[0]?.split('-')[0]?.toLowerCase();
    if (base && SUPPORTED_LOCALES.includes(base as any)) return base as typeof SUPPORTED_LOCALES[number];
  }
  return 'fr';
}

const locale = resolveLocale();

const TEXT = {
  fr: {
    metadataTitle: 'Merci — TonSiteWeb.ch',
    headingWithSession: 'Merci pour votre commande',
    headingGeneric: 'Merci',
    descAwaiting: 'Nous confirmons votre paiement…',
    descGeneric: 'Nous revenons vers vous sous un jour ouvré.',
    descConfirmed: 'Votre paiement est confirmé. Vous recevrez un e-mail avec les prochaines étapes.',
    emailLabel: 'Email',
    orderLabel: 'Commande n°',
    amountLabel: 'Montant',
    statusLabel: 'Statut',
    templateLabel: 'Modèle',
    planLabel: 'Plan',
    loading: 'Chargement des détails du paiement…',
    error: 'Impossible de charger les détails. Merci de contacter le support.',
    home: "Revenir à l’accueil",
    currencyLocale: 'fr-CH',
  },
  en: {
    metadataTitle: 'Thank you — TonSiteWeb.ch',
    headingWithSession: 'Thank you for your order',
    headingGeneric: 'Thank you',
    descAwaiting: 'We are confirming your payment…',
    descGeneric: 'We will get back to you within one business day.',
    descConfirmed: 'Your payment is confirmed. You will receive an email with the next steps.',
    emailLabel: 'Email',
    orderLabel: 'Order #',
    amountLabel: 'Amount',
    statusLabel: 'Status',
    templateLabel: 'Template',
    planLabel: 'Plan',
    loading: 'Loading payment details…',
    error: 'Unable to load details. Please contact support.',
    home: 'Back to homepage',
    currencyLocale: 'en-CH',
  },
  it: {
    metadataTitle: 'Grazie — TonSiteWeb.ch',
    headingWithSession: 'Grazie per il tuo ordine',
    headingGeneric: 'Grazie',
    descAwaiting: 'Stiamo confermando il pagamento…',
    descGeneric: 'Ti ricontatteremo entro un giorno lavorativo.',
    descConfirmed: 'Il pagamento è confermato. Riceverai un’email con i prossimi passi.',
    emailLabel: 'Email',
    orderLabel: 'Ordine n°',
    amountLabel: 'Importo',
    statusLabel: 'Stato',
    templateLabel: 'Template',
    planLabel: 'Piano',
    loading: 'Caricamento dei dettagli del pagamento…',
    error: 'Impossibile caricare i dettagli. Contatta il supporto.',
    home: 'Torna alla home',
    currencyLocale: 'it-CH',
  },
  de: {
    metadataTitle: 'Danke — TonSiteWeb.ch',
    headingWithSession: 'Danke für Ihre Bestellung',
    headingGeneric: 'Danke',
    descAwaiting: 'Wir bestätigen gerade Ihre Zahlung…',
    descGeneric: 'Wir melden uns innerhalb eines Werktages.',
    descConfirmed: 'Ihre Zahlung ist bestätigt. Sie erhalten in Kürze eine E-Mail mit den nächsten Schritten.',
    emailLabel: 'E-Mail',
    orderLabel: 'Bestellung Nr.',
    amountLabel: 'Betrag',
    statusLabel: 'Status',
    templateLabel: 'Vorlage',
    planLabel: 'Plan',
    loading: 'Zahlungsdetails werden geladen…',
    error: 'Details konnten nicht geladen werden. Bitte kontaktieren Sie den Support.',
    home: 'Zur Startseite',
    currencyLocale: 'de-CH',
  },
} as const;

const copy = TEXT[locale];
const metadata = { title: copy.metadataTitle };
const sessionId = Astro.url.searchParams.get('session_id') || '';
const hasSession = Boolean(sessionId);
---

<Layout metadata={metadata}>
  <section class="py-24">
    <div class="container mx-auto max-w-2xl text-center">
      <h1 class="text-3xl font-bold">{hasSession ? copy.headingWithSession : copy.headingGeneric}</h1>
      <p class="mt-4 text-muted" id="desc">{hasSession ? copy.descAwaiting : copy.descGeneric}</p>

      {hasSession ? (
        <div id="session" class="mt-8 text-left mx-auto max-w-lg rounded border border-gray-200 dark:border-gray-700 p-4 text-sm bg-white/50 dark:bg-slate-900/50">
          <div id="loader">{copy.loading}</div>
          <div id="content" class="hidden">
            <p><strong>{copy.emailLabel}:</strong> <span id="email">—</span></p>
            <p><strong>{copy.orderLabel}</strong> <span id="orderNumber">—</span></p>
            <p><strong>{copy.amountLabel}:</strong> <span id="amount">—</span></p>
            <p><strong>{copy.planLabel}:</strong> <span id="plan">—</span></p>
            <p><strong>{copy.templateLabel}:</strong> <span id="template">—</span></p>
            <p><strong>{copy.statusLabel}:</strong> <span id="status">—</span></p>
          </div>
          <div id="error" class="hidden text-red-600">{copy.error}</div>
        </div>
      ) : null}

      <a href="/" class="btn btn-primary mt-8">{copy.home}</a>
    </div>
  </section>

  {hasSession ? (
    <script is:inline>
      const copy = ${JSON.stringify(copy)};
      const params = new URLSearchParams(location.search);
      const id = params.get('session_id');
      if (id) {
        fetch(`/api/payment/session?session_id=${encodeURIComponent(id)}`)
          .then(r => (r.ok ? r.json() : Promise.reject(new Error('HTTP ' + r.status))))
          .then(data => {
            const amountMinor = typeof data.amount_total_order === 'number' ? data.amount_total_order : data.amount_total;
            const currency = (data.currency || 'CHF').toUpperCase();
            const formatter = new Intl.NumberFormat(copy.currencyLocale, { style: 'currency', currency });
            document.getElementById('email').textContent = data.customer_email || data.metadata?.email || '—';
            document.getElementById('orderNumber').textContent = data.order_number || '—';
            document.getElementById('amount').textContent = typeof amountMinor === 'number' ? formatter.format((amountMinor || 0) / 100) : '—';
            document.getElementById('status').textContent = data.payment_status || '—';
            document.getElementById('template').textContent = data.template || data.metadata?.template || '—';
            document.getElementById('plan').textContent = data.plan || data.metadata?.plan || '—';
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('desc').textContent = copy.descConfirmed;
          })
          .catch(() => {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
          });
      }
    </script>
  ) : null}
</Layout>
