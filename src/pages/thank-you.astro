---
import Layout from '~/layouts/PageLayout.astro';

const metadata = { title: 'Merci — TonSiteWeb.ch' };
const sessionId = Astro.url.searchParams.get('session_id') || '';
---

<Layout metadata={metadata}>
  <section class="py-24">
    <div class="container mx-auto max-w-2xl text-center">
      <h1 class="text-3xl font-bold">{sessionId ? 'Merci pour votre commande' : 'Merci'}</h1>
      <p class="mt-4 text-muted" id="desc">{sessionId ? 'Nous confirmons votre paiement…' : 'Nous revenons vers vous sous un jour ouvré.'}</p>

      {sessionId ? (
        <div id="session" class="mt-8 text-left mx-auto max-w-lg rounded border border-gray-200 dark:border-gray-700 p-4 text-sm bg-white/50 dark:bg-slate-900/50">
          <div id="loader">Chargement des détails du paiement…</div>
          <div id="content" class="hidden">
            <p><strong>Email:</strong> <span id="email"></span></p>
            <p><strong>Montant:</strong> <span id="amount"></span></p>
            <p><strong>Statut:</strong> <span id="status"></span></p>
            <p><strong>Modèle:</strong> <span id="template"></span></p>
            <p><strong>Plan:</strong> <span id="plan"></span></p>
          </div>
          <div id="error" class="hidden text-red-600">Impossible de charger les détails. Merci de contacter le support.</div>
        </div>
      ) : null}

      <a href="/" class="btn btn-primary mt-8">Revenir à l’accueil</a>
    </div>
  </section>

  {sessionId ? (
    <script is:inline>
      const params = new URLSearchParams(location.search);
      const id = params.get('session_id');
      if (id) {
        fetch(`/api/payment/session?session_id=${encodeURIComponent(id)}`)
          .then(r => r.ok ? r.json() : Promise.reject(new Error('HTTP ' + r.status)))
          .then(data => {
            const f = new Intl.NumberFormat('fr-CH', { style: 'currency', currency: data.currency || 'CHF' });
            document.getElementById('email').textContent = data.customer_email || '—';
            document.getElementById('amount').textContent = typeof data.amount_total === 'number' ? f.format((data.amount_total||0)/100) : '—';
            document.getElementById('status').textContent = data.payment_status || '—';
            document.getElementById('template').textContent = data.metadata?.template || '—';
            document.getElementById('plan').textContent = data.metadata?.plan || '—';
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('desc').textContent = 'Votre paiement est confirmé. Vous recevrez un e-mail avec les prochaines étapes.';
          })
          .catch(() => {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
          });
      }
    </script>
  ) : null}
</Layout>
