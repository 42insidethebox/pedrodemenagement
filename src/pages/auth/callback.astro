---
import '~/assets/styles/tailwind.css';
import ToggleTheme from '~/components/common/ToggleTheme.astro';
import BasicScripts from '~/components/common/BasicScripts.astro';
import ApplyColorMode from '~/components/common/ApplyColorMode.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import CommonMeta from '~/components/common/CommonMeta.astro';
import Favicons from '~/components/Favicons.astro';
import Metadata from '~/components/common/Metadata.astro';
import SiteVerification from '~/components/common/SiteVerification.astro';
import Analytics from '~/components/common/Analytics.astro';
import { I18N } from 'astrowind:config';
const { language, textDirection } = I18N;
---
<html lang={language} dir={textDirection} class="2xl:text-[20px]">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email confirmed · TonSiteWeb</title>
    <CommonMeta />
    <Favicons />
    <CustomStyles />
    <ApplyColorMode />
    <Metadata />
    <SiteVerification />
    <Analytics />
  </head>
  <body class="min-h-screen flex items-center justify-center p-6 antialiased text-default bg-page tracking-tight">
    <div class="fixed top-3 right-3 hidden md:flex items-center gap-2">
      <ToggleTheme iconClass="w-6 h-6 md:w-5 md:h-5" />
      <div class="relative dropdown">
        <button type="button" class="hover:text-link dark:hover:text-white px-3 min-[1100px]:px-4 py-2.5 flex items-center whitespace-nowrap">
          Lingua
          <svg width="1em" height="1em" viewBox="0 0 24 24" class="w-3.5 h-3.5 ml-0.5 hidden md:inline" data-icon="tabler:chevron-down"><path fill="currentColor" d="M7 10l5 5l5-5" /></svg>
        </button>
        <ul class="dropdown-menu md:backdrop-blur-md dark:md:bg-dark rounded md:absolute pl-4 md:pl-0 md:hidden font-medium md:bg-white/90 md:min-w-[200px] drop-shadow-xl">
          <li><a class="first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block" href="#" data-lang="fr"> Français </a></li>
          <li><a class="first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block" href="#" data-lang="en"> English </a></li>
          <li><a class="first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block" href="#" data-lang="de"> Deutsch </a></li>
          <li><a class="first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block" href="#" data-lang="it"> Italiano </a></li>
        </ul>
      </div>
    </div>
    <section class="w-full max-w-md rounded-2xl border border-slate-200 bg-white p-6 shadow-md shadow-slate-200/60 dark:border-slate-800 dark:bg-slate-900/60 dark:shadow-xl dark:shadow-slate-950/40 text-center">
      <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-50 text-blue-600 dark:bg-blue-500/10 dark:text-blue-300">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-6 w-6" aria-hidden="true">
          <path d="M12 8v4l2.5 2.5" stroke-linecap="round" stroke-linejoin="round"></path>
          <circle cx="12" cy="12" r="9"></circle>
        </svg>
      </div>
      <h1 id="callback-status" class="mt-4 text-xl font-semibold text-slate-900 dark:text-white">Verifying your account…</h1>
      <p id="callback-message" class="mt-2 text-sm text-slate-600 dark:text-slate-400">Hang tight while we activate your TonSiteWeb workspace.</p>
      <div class="mt-6 flex flex-col gap-3">
        <a
          id="callback-primary"
          href="/app"
          class="hidden w-full items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-md shadow-blue-500/30 transition hover:bg-blue-500"
        >
          Go to your workspace
        </a>
        <a
          id="callback-secondary"
          href="/auth/signin"
          class="inline-flex w-full items-center justify-center rounded-lg border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800"
        >
          Back to sign in
        </a>
      </div>
    </section>
    <BasicScripts />
    <script type="module">
      // Language switch for auth page
      function computeLangHref(lang) {
        const path = location.pathname;
        const search = location.search || '';
        const hash = location.hash || '';
        const rawPath = path.replace(/^\/(fr|en|de|it)(?=\/|$)/, '') || '/';
        const base = rawPath === '/' ? '' : rawPath;
        return lang === 'fr' ? `${base}${search}${hash}` : `/${lang}${base}${search}${hash}`;
      }
      document.querySelectorAll('[data-lang]').forEach((a) => {
        const lang = a.getAttribute('data-lang');
        if (!lang) return;
        a.setAttribute('href', computeLangHref(lang));
      });
      const status = document.getElementById('callback-status');
      const message = document.getElementById('callback-message');
      const primary = document.getElementById('callback-primary');
      const secondary = document.getElementById('callback-secondary');

      function setAuthSession(session) {
        if (typeof window === 'undefined') return;
        try {
          window.localStorage.setItem('tonsiteweb:accessToken', session.accessToken);
          if (session.refreshToken) {
            window.localStorage.setItem('tonsiteweb:refreshToken', session.refreshToken);
          }
        } catch (storageError) {
          console.warn('Unable to persist auth session', storageError);
        }
      }

      const params = new URLSearchParams(location.search);
      const errorMessage =
        params.get('error_description') || params.get('error') || params.get('message') || params.get('error_code');
      const accessToken = params.get('access_token') || '';
      const refreshToken = params.get('refresh_token') || '';
      const expiresAtParam = params.get('expires_at');
      const expiresInParam = params.get('expires_in');
      const otpToken = params.get('token') || '';
      const email = params.get('email') || '';
      const type = params.get('type') || 'signup';
      const next = params.get('next') || '/app';

      function sanitizeNext(value) {
        if (!value) return '/app';
        if (!/^\/[a-zA-Z0-9\-_/]*$/.test(value)) return '/app';
        if (value.includes('..')) return '/app';
        return value;
      }

      function updateHistory(cleanNext) {
        try {
          const sanitizedNext = sanitizeNext(cleanNext);
          const url = new URL(location.href);
          url.search = sanitizedNext && sanitizedNext !== '/app' ? `?next=${encodeURIComponent(sanitizedNext)}` : '';
          window.history.replaceState({}, '', url.toString());
        } catch (_) {
          // ignore history failures
        }
      }

      function showError(text) {
        if (status) status.textContent = 'We could not verify your account';
        if (message) message.textContent = text || 'Please request a new confirmation email.';
        primary?.classList.add('hidden');
        secondary?.classList.remove('hidden');
      }

      async function verify() {
        if (errorMessage) {
          showError(errorMessage);
          return;
        }

        if (status) status.textContent = 'Finalising your account…';
        if (message)
          message.textContent = 'Securing your workspace and setting up your session. This only takes a moment.';

        const expiresAt = expiresAtParam
          ? Number(expiresAtParam)
          : expiresInParam
          ? Math.floor(Date.now() / 1000) + Number(expiresInParam)
          : null;

        const payload = {
          accessToken,
          refreshToken,
          token: otpToken,
          email,
          type,
          expiresAt,
          next,
        };

        try {
          const response = await fetch('/api/auth/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await response.json().catch(() => ({}));

          if (!response.ok) {
            throw new Error(data?.error || 'Verification failed');
          }

          if (data?.session?.accessToken) {
            setAuthSession({
              accessToken: data.session.accessToken,
              refreshToken: data.session.refreshToken || undefined,
            });
          }

          const destination = sanitizeNext(data?.next || next);
          updateHistory(destination);

          if (status) status.textContent = 'Account verified';
          if (message)
            message.textContent = 'Welcome aboard! Your workspace is ready – we’ll take you there automatically.';
          if (primary) {
            primary.classList.remove('hidden');
            primary.setAttribute('href', destination);
            primary.textContent = 'Enter your workspace';
          }
          if (secondary) {
            secondary.textContent = 'Manage another sign in';
            secondary.setAttribute('href', '/auth/signin');
          }

          setTimeout(() => {
            try {
              location.href = destination;
            } catch (_) {
              // ignore redirect issues
            }
          }, 1500);
        } catch (error) {
          console.error('Verification failed', error);
          showError(error instanceof Error ? error.message : 'Verification failed.');
        }
      }

      verify();
    </script>
  </body>
  </html>
